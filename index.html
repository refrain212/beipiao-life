<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŒ—æ¼‚äººç”Ÿ</title>
  <style>
    body {
      font-family: "Microsoft Yahei", sans-serif;
      background: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }
    #status-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 220px;
      text-align: left;
      line-height: 1.6;
      display: none;
    }
    #status-box p {
      margin: 0;
      padding: 2px 0;
      border-bottom: 1px dashed #eee;
    }
    #status-box p:last-child {
      border-bottom: none;
    }
    #items-box {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 220px;
      text-align: left;
      line-height: 1.6;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    #items-box .item-slot {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 2px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
      text-align: center;
      cursor: pointer;
      vertical-align: top;
      position: relative;
    }
    #items-box .item-slot:hover {
      border-color: #0078d7;
      background: #f0f8ff;
    }
    #items-box .item-slot .item-name {
      font-size: 10px;
      margin-top: 5px;
      line-height: 1.2;
    }
    #items-box .item-slot .item-count {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background: #0078d7;
      color: white;
      border-radius: 8px;
      font-size: 10px;
      padding: 1px 4px;
      min-width: 12px;
    }
    #game-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 400px;
      text-align: center;
    }
    /* å¼¹çª—æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      width: 350px;
      text-align: center;
      animation: modalShow 0.3s ease-out;
    }
    @keyframes modalShow {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .modal-content h3 {
      margin: 0 0 15px 0;
      color: #0078d7;
    }
    .modal-content .item-info {
      margin: 15px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      text-align: left;
    }
    .modal-buttons {
      margin-top: 20px;
    }
    .modal-buttons button {
      margin: 0 5px;
    }
    /* æ¸¸æˆå†…å¼¹çª—æ ·å¼ */
    .game-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .game-popup-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      width: 380px;
      text-align: center;
      animation: gamePopupShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid #0078d7;
    }
    @keyframes gamePopupShow {
      from {
        opacity: 0;
        transform: scale(0.5) translateY(-50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    .game-popup h3 {
      margin: 0 0 15px 0;
      color: #0096d7;
      font-size: 18px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }
    .game-popup .popup-message {
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      text-align: left;
      line-height: 1.6;
      border-left: none;
    }
    .game-popup .popup-effects {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 8px;
      color: #2d5a3d;
      font-size: 14px;
      border: 1px solid #b8e6b8;
    }
    .game-popup-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .game-popup-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      min-width: 80px;
    }
    .popup-btn-primary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
    }
    .popup-btn-primary:hover {
      background: linear-gradient(135deg, #218838 0%, #1c7d73 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(40, 167, 69, 0.4);
    }
    .popup-btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(108, 117, 125, 0.3);
    }
    .popup-btn-secondary:hover {
      background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(108, 117, 125, 0.4);
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #0078d7;
      color: white;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #005fa3;
    }
    input {
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      margin-top: 10px;
      width: 80%;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input:focus {
      outline: none;
      border-color: #0078d7;
      box-shadow: 0 0 10px rgba(0,120,215,0.3);
      transform: translateY(-2px);
    }
    input::placeholder {
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="status-box"></div>
  <!-- æ‚ç‰©é—´æŒ‰é’® -->
  <div id="items-button" style="position: fixed; bottom: 20px; left: 20px; display: none;">
    <button onclick="openItemsDialog()" style="padding: 10px 15px; background: #0078d7; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      ğŸ“¦ æ‚ç‰©é—´
    </button>
  </div>
  
  <!-- é“å…·ä½¿ç”¨ç¡®è®¤å¼¹çª— -->
  <div id="item-confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>ä½¿ç”¨é“å…·</h3>
      <div id="modal-item-info" class="item-info"></div>
      <div class="modal-buttons">
        <button onclick="confirmUseItem()" style="background: #28a745;">ç¡®è®¤ä½¿ç”¨</button>
        <button onclick="closeItemModal()" style="background: #6c757d;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  
  <!-- æ‚ç‰©é—´ç•Œé¢å¼¹çª— -->
  <div id="items-dialog-modal" class="modal-overlay">
    <div class="modal-content" style="width: 450px;">
      <h3>ğŸ“¦ æ‚ç‰©é—´</h3>
      <div id="items-dialog-grid" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
      <div class="modal-buttons">
        <button onclick="closeItemsDialog()" style="background: #6c757d;">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <!-- æ¸¸æˆå†…è‡ªå®šä¹‰å¼¹çª— -->
  <div id="game-popup" class="game-popup">
    <div class="game-popup-content">
      <h3 id="popup-title">æ¶ˆæ¯</h3>
      <div id="popup-message" class="popup-message"></div>
      <div id="popup-effects" class="popup-effects" style="display: none;"></div>
      <div class="game-popup-buttons">
        <button id="popup-btn-ok" class="popup-btn-primary" onclick="closeGamePopup()">ç¡®å®š</button>
      </div>
    </div>
  </div>
  
  <div id="game-container">
    <h2 style="color: #0078d7; margin-bottom: 20px; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">ğŸ™ï¸ åŒ—æ¼‚äººç”Ÿ</h2>
    <div id="start-screen">
      <p style="font-size: 18px; color: #333; margin-bottom: 15px;">è¯·è¾“å…¥ä½ çš„å§“åï¼š</p>
      <input type="text" id="name-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„åå­—...">
      <br>
      <p style="font-size: 16px; color: #333; margin: 20px 0 10px 0;">é€‰æ‹©ä½ çš„ç”Ÿæ—¥ï¼š</p>
      <div style="margin: 10px 0;">
        <select id="birth-month" style="padding: 8px; margin-right: 10px; border-radius: 5px; border: 2px solid #e0e0e0;" onchange="updateDayOptions()">
          <option value="0">1æœˆ</option>
          <option value="1">2æœˆ</option>
          <option value="2">3æœˆ</option>
          <option value="3">4æœˆ</option>
          <option value="4">5æœˆ</option>
          <option value="5">6æœˆ</option>
          <option value="6">7æœˆ</option>
          <option value="7">8æœˆ</option>
          <option value="8">9æœˆ</option>
          <option value="9">10æœˆ</option>
          <option value="10">11æœˆ</option>
          <option value="11">12æœˆ</option>
        </select>
        <select id="birth-day" style="padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
          <!-- åŠ¨æ€ç”Ÿæˆæ—¥æœŸé€‰é¡¹ -->
        </select>
      </div>
      <button onclick="startGame()" style="margin-top: 20px; padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #0078d7 0%, #005fa3 100%); border-radius: 10px; box-shadow: 0 4px 10px rgba(0,120,215,0.3);">å¼€å§‹æ¸¸æˆ</button>
    </div>
    <div id="game-screen" style="display:none;"></div>
  </div>

  <script>
    // æ¸¸æˆæ•°æ®
    // å…¬å¸æ•°æ®åº“
    const companies = [
      { name: "å­—èŠ‚è·³åŠ¨", minSkill: 1200, income: 25000, desc: "äº’è”ç½‘å·¨å¤´ï¼Œå·¥ä½œå¼ºåº¦è¾ƒå¤§" },
      { name: "è…¾è®¯", minSkill: 1300, income: 28000, desc: "ç¯å¢ƒç¨³å®šï¼Œç¦åˆ©ä¼˜åš" },
      { name: "é˜¿é‡Œå·´å·´", minSkill: 1400, income: 30000, desc: "996ç¦æŠ¥" },
      { name: "ç™¾åº¦", minSkill: 1100, income: 22000, desc: "è€ç‰Œå¤§å‚" },
      { name: "äº¬ä¸œ", minSkill: 1000, income: 20000, desc: "ç”µå•†å¤§å‚" },
      { name: "ç¾å›¢", minSkill: 950, income: 18000, desc: "å‘å±•è¿…é€Ÿ" },
      { name: "ç½‘æ˜“", minSkill: 1050, income: 21000, desc: "æ°›å›´è½»æ¾" },
      { name: "å°ç±³", minSkill: 900, income: 17000, desc: "å¹´è½»æœ‰æ´»åŠ›" },
      { name: "å¿«æ‰‹", minSkill: 1150, income: 24000, desc: "å‘å±•ç©ºé—´å¤§" },
      { name: "æ»´æ»´", minSkill: 1000, income: 19000, desc: "å¹³å°è§„æ¨¡å¤§" },
      { name: "æ‹¼å¤šå¤š", minSkill: 1200, income: 26000, desc: "é«˜å¼ºåº¦é«˜å›æŠ¥" },
      { name: "çŒ¿è¾…å¯¼", minSkill: 850, income: 16000, desc: "æ•™è‚²ç§‘æŠ€" },
      { name: "BOSSç›´è˜", minSkill: 800, income: 15000, desc: "ç¯å¢ƒå‹å¥½" }
    ];

    // ä½æˆ¿æ•°æ®åº“
    const houses = [
      // äº”ç¯å¤–æ¡£æ¬¡
      { name: "äº”ç¯å¤–è€æ—§å•é—´", rent: 2500, sleepMoodBonus: -2, sleepEnergyBonus: -3, gameMoodBonus: -1, desc: "å¹´ä¹…å¤±ä¿®ï¼Œéš”éŸ³å·®" },
      { name: "äº”ç¯å¤–æ™®é€šå•é—´", rent: 3000, sleepMoodBonus: 0, sleepEnergyBonus: 0, gameMoodBonus: 0, desc: "ä¾¿å®œä½†æ¡ä»¶ä¸€èˆ¬" },
      { name: "äº”ç¯å¤–è£…ä¿®å•é—´", rent: 3500, sleepMoodBonus: 1, sleepEnergyBonus: 2, gameMoodBonus: 1, desc: "ç®€å•è£…ä¿®ï¼Œç¨å¾®èˆ’é€‚" },
      
      // å››ç¯è¾¹æ¡£æ¬¡
      { name: "å››ç¯è¾¹è€å¼ä¸€å±…", rent: 4000, sleepMoodBonus: 2, sleepEnergyBonus: 3, gameMoodBonus: 1, desc: "ç‹¬ç«‹ç©ºé—´ä½†è®¾æ–½é™ˆæ—§" },
      { name: "å››ç¯è¾¹æ ‡å‡†ä¸€å±…", rent: 4500, sleepMoodBonus: 3, sleepEnergyBonus: 5, gameMoodBonus: 2, desc: "ç‹¬ç«‹ç©ºé—´ï¼Œç¯å¢ƒè¾ƒå¥½" },
      { name: "å››ç¯è¾¹é‡‡å…‰ä¸€å±…", rent: 5000, sleepMoodBonus: 5, sleepEnergyBonus: 4, gameMoodBonus: 3, desc: "å—åŒ—é€šé€ï¼Œé‡‡å…‰æä½³" },
      
      // ä¸‰ç¯å†…æ¡£æ¬¡
      { name: "ä¸‰ç¯å†…æ™®é€šä¸€å±…", rent: 5500, sleepMoodBonus: 4, sleepEnergyBonus: 6, gameMoodBonus: 3, desc: "äº¤é€šä¾¿åˆ©ï¼Œç”Ÿæ´»æ–¹ä¾¿" },
      { name: "ä¸‰ç¯å†…ç²¾è£…ä¸€å±…", rent: 6500, sleepMoodBonus: 6, sleepEnergyBonus: 8, gameMoodBonus: 4, desc: "è£…ä¿®ç²¾ç¾ï¼Œè®¾æ–½é½å…¨" },
      { name: "ä¸‰ç¯å†…æ™¯è§‚ä¸€å±…", rent: 7000, sleepMoodBonus: 8, sleepEnergyBonus: 7, gameMoodBonus: 5, desc: "é«˜å±‚æ™¯è§‚ï¼Œè§†é‡å¼€é˜”" },
      
      // äºŒç¯è±ªåæ¡£æ¬¡
      { name: "äºŒç¯æ ‡å‡†å…¬å¯“", rent: 8000, sleepMoodBonus: 7, sleepEnergyBonus: 10, gameMoodBonus: 5, desc: "é«˜ç«¯å°åŒºï¼Œè®¾æ–½å®Œå–„" },
      { name: "äºŒç¯è±ªåå…¬å¯“", rent: 9500, sleepMoodBonus: 10, sleepEnergyBonus: 12, gameMoodBonus: 7, desc: "å¥¢åè£…ä¿®ï¼Œç®¡å®¶æœåŠ¡" },
      { name: "äºŒç¯é¡¶çº§å…¬å¯“", rent: 11000, sleepMoodBonus: 12, sleepEnergyBonus: 15, gameMoodBonus: 8, desc: "é¡¶çº§é…ç½®ï¼Œç§äººç®¡å®¶" },
      
      // å¸‚ä¸­å¿ƒé¡¶çº§æ¡£æ¬¡
      { name: "å¸‚ä¸­å¿ƒå•†åŠ¡å…¬å¯“", rent: 12000, sleepMoodBonus: 10, sleepEnergyBonus: 18, gameMoodBonus: 6, desc: "å•†åŠ¡é…ç½®ï¼Œæ•ˆç‡ä¼˜å…ˆ" },
      { name: "å¸‚ä¸­å¿ƒç²¾è£…è±ªå®…", rent: 15000, sleepMoodBonus: 15, sleepEnergyBonus: 20, gameMoodBonus: 10, desc: "åœ°æ®µä¼˜è¶Šï¼Œè£…ä¿®ç²¾ç¾" },
      { name: "å¸‚ä¸­å¿ƒé¡¶çº§è±ªå®…", rent: 20000, sleepMoodBonus: 20, sleepEnergyBonus: 25, gameMoodBonus: 15, desc: "å¥¢åè‡³æï¼Œèº«ä»½è±¡å¾" }
    ];

    // é“å…·æ•°æ®åº“
    const items = [
      { id: 1, name: "æ¸¸æˆå¡å¸¦", price: 300, desc: "æœ€æ–°çš„3Aå¤§ä½œï¼Œç”»é¢ç²¾ç¾", energyCost: -5, moodGain: 25 },
      { id: 2, name: "å’–å•¡è±†", price: 80, desc: "ç²¾å“å’–å•¡è±†ï¼Œæç¥é†’è„‘", energyGain: 20, moodGain: 10 },
      { id: 3, name: "æŒ‰æ‘©å™¨", price: 500, desc: "ç¼“è§£ç–²åŠ³çš„ç¥å™¨", energyGain: 30, moodGain: 15 },
      { id: 4, name: "ç¼–ç¨‹ä¹¦ç±", price: 150, desc: "æå‡ç¼–ç¨‹æŠ€èƒ½çš„å¥½ä¹¦", skillGain: 10, moodGain: 5 },
      { id: 5, name: "è‚¥å®…å¿«ä¹æ°´", price: 50, desc: "æ€»ä¹‹å°±æ˜¯å¾ˆå¿«ä¹", moodGain: 20 },
      { id: 6, name: "è›‹ç™½ç²‰", price: 120, desc: "å¥èº«äººå£«å¿…å¤‡", moodGain: 2, special: "gym_bonus" }
    ];

    // æ—¥æœŸå¤„ç†å‡½æ•°
    function getDaysInMonth(month, year = 2005) {
      // æœˆä»½æ˜¯0-11ï¼Œè¿™é‡Œè½¬æ¢ä¸º1-12æ¥è®¡ç®—
      return new Date(year, month + 1, 0).getDate();
    }

    function updateDayOptions() {
      const monthSelect = document.getElementById("birth-month");
      const daySelect = document.getElementById("birth-day");
      const selectedMonth = parseInt(monthSelect.value);
      const currentDay = parseInt(daySelect.value) || 1;
      
      // æ¸…é™¤ç°æœ‰é€‰é¡¹
      daySelect.innerHTML = '';
      
      // è·å–è¯¥æœˆçš„å¤©æ•°
      const daysInMonth = getDaysInMonth(selectedMonth);
      
      // ç”Ÿæˆæ—¥æœŸé€‰é¡¹
      for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + 'æ—¥';
        if (day === currentDay && day <= daysInMonth) {
          option.selected = true;
        } else if (day === 1 && currentDay > daysInMonth) {
          option.selected = true;
        }
        daySelect.appendChild(option);
      }
    }

    // è®¡ç®—æ¸¸æˆå¼€å§‹æ—¥æœŸï¼ˆç¡®ä¿ä¸»è§’å¼€å±€æ—¶22å²ï¼‰
    function calculateGameStartDate(birthMonth, birthDay) {
      const birthYear = 2005;
      const currentYear = 2027; // 22å²æ—¶åº”è¯¥æ˜¯2027å¹´
      
      // æ¸¸æˆå¼€å§‹æ—¥æœŸå°±æ˜¯22å²ç”Ÿæ—¥å½“å¤©ï¼ˆå…¥èŒç¬¬ä¸€å¤©ï¼‰
      const gameStart = new Date(currentYear, birthMonth, birthDay);
      
      return gameStart;
    }

    let player = {
      name: "",
      age: 22,
      birthMonth: 0, // ç”Ÿæ—¥æœˆä»½ (0-11)
      birthDay: 1,   // ç”Ÿæ—¥æ—¥æœŸ (1-31)
      money: 10000,
      income: 8000,
      rent: 0, // åˆå§‹æ²¡æœ‰æˆ¿ç§Ÿ
      energy: 100,
      maxEnergy: 100,
      mood: 100,
      skill: 500,  // å·¥ä½œèƒ½åŠ›
      company: "å°å‹äº’è”ç½‘å…¬å¸",
      house: "", // åˆå§‹æ²¡æœ‰æˆ¿å­
      inventory: {}, // é“å…·åº“å­˜
      gymBonus: false, // è›‹ç™½ç²‰å¥èº«åŠ æˆçŠ¶æ€
      lastJobChange: new Date(2025, 8, 1), // ä¸Šæ¬¡è·³æ§½æ—¶é—´
      lastSalaryRaise: new Date(2025, 8, 1), // ä¸Šæ¬¡æ¶¨è–ªæ—¶é—´
      lastHouseChange: new Date(2025, 8, 1), // ä¸Šæ¬¡æ¢æˆ¿æ—¶é—´
      monthlyJobAttempts: 0, // æœ¬æœˆè·³æ§½å°è¯•æ¬¡æ•°
      lastJobAttemptMonth: 8 // ä¸Šæ¬¡è·³æ§½å°è¯•çš„æœˆä»½
    };

    let gameDate = new Date(2025, 8, 1);
    let hasPerfectAttendance = true;
    let absentDays = 0;
    let changes = {}; // å…¨å±€å˜åŒ–é‡è®°å½•

    // å·¥å…·å‡½æ•°ï¼šåº”ç”¨å±æ€§å˜åŒ–
    function applyChange(key, value) {
      if (key === 'mood') {
        player.mood = Math.max(0, Math.min(100, player.mood + value));
      } else if (key === 'energy') {
        player.energy = Math.min(player.maxEnergy, player.energy + value);
      } else if (key === 'maxEnergy') {
        player.maxEnergy = Math.min(120, player.maxEnergy + value);
      } else {
        player[key] += value;
      }
      changes[key] = (changes[key] || 0) + value;
    }

    // é‡ç½®å˜åŒ–é‡è®°å½•
    function resetChanges() {
      changes = {};
    }

    // é“å…·ç›¸å…³å‡½æ•°
    function addItem(itemId, quantity = 1) {
      if (!player.inventory[itemId]) {
        player.inventory[itemId] = 0;
      }
      player.inventory[itemId] += quantity;
    }

    function useItem(itemId) {
      if (!player.inventory[itemId] || player.inventory[itemId] <= 0) {
        return false;
      }
      
      const item = items.find(i => i.id === itemId);
      if (!item) return false;
      
      resetChanges();
      
      if (item.energyGain) applyChange('energy', item.energyGain);
      if (item.energyCost) applyChange('energy', item.energyCost);
      if (item.moodGain) applyChange('mood', item.moodGain);
      if (item.skillGain) applyChange('skill', item.skillGain);
      if (item.maxEnergyGain) applyChange('maxEnergy', item.maxEnergyGain);
      
      // å¤„ç†è›‹ç™½ç²‰ç‰¹æ®Šæ•ˆæœ
      if (item.special === "gym_bonus") {
        player.gymBonus = true;
      }
      
      player.inventory[itemId]--;
      updateStatusBox();
      
      return true;
    }

    function getDateString() {
      const weekDays = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
      return `${gameDate.getFullYear()}.${gameDate.getMonth() + 1}.${gameDate.getDate()} ${weekDays[gameDate.getDay()]}`;
    }

    function updateStatusBox() {
      const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
      const birthday = `${monthNames[player.birthMonth]}${player.birthDay}æ—¥`;
      
      const statusBox = document.getElementById("status-box");
      statusBox.innerHTML = `
        <p>æ—¥æœŸï¼š${getDateString()}</p>
        <p>å§“åï¼š${player.name} | å¹´é¾„ï¼š${player.age}å²</p>
        <p>ç”Ÿæ—¥ï¼š${birthday}</p>
        <p>å…¬å¸ï¼š${player.company}</p>
        <p>æœˆè–ªï¼š${player.income}å…ƒ</p>
        <p>ä½æˆ¿ï¼š${player.house || "æš‚æ— "}</p>
        <p>æˆ¿ç§Ÿï¼š${player.rent}å…ƒ</p>
        <p>ä½“åŠ›ï¼š${player.energy}/${player.maxEnergy}</p>
        <p>å¿ƒæƒ…ï¼š${player.mood}</p>
        <p>èƒ½åŠ›ï¼š${player.skill}</p>
        <p>å­˜æ¬¾ï¼š${player.money}å…ƒ</p>
        ${player.house ? '<button onclick="careerMenu()" style="width:100%; margin-top:5px;">å…³äºå·¥ä½œ...</button>' : ''}
        ${player.house ? '<button onclick="housingMenu()" style="width:100%; margin-top:5px;">å…³äºä½æˆ¿...</button>' : ''}
      `;
      updateItemsButton();
    }

    // æ›´æ–°æ‚ç‰©é—´æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    function updateItemsButton() {
      const itemsButton = document.getElementById("items-button");
      if (!itemsButton) return;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é“å…·
      let hasItems = false;
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          hasItems = true;
          break;
        }
      }
      
      // åªæœ‰åœ¨æ¸¸æˆå¼€å§‹ä¸”æœ‰é“å…·æ—¶æ‰æ˜¾ç¤ºæŒ‰é’®
      if (player.name) {
        itemsButton.style.display = "block";
      } else {
        itemsButton.style.display = "none";
      }
    }

    // æ‰“å¼€æ‚ç‰©é—´å¯¹è¯æ¡†
    function openItemsDialog() {
      const modal = document.getElementById("items-dialog-modal");
      const itemsGrid = document.getElementById("items-dialog-grid");
      
      // è·å–ç©å®¶æ‹¥æœ‰çš„é“å…·
      let ownedItems = [];
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          const item = items.find(i => i.id == itemId);
          if (item) {
            ownedItems.push({...item, quantity: player.inventory[itemId]});
          }
        }
      }
      
      if (ownedItems.length === 0) {
        itemsGrid.innerHTML = '<p style="color:#999; text-align:center; margin:20px 0;">æ‚ç‰©é—´ç©ºç©ºå¦‚ä¹Ÿ</p>';
      } else {
        itemsGrid.innerHTML = ownedItems.map(item => `
          <div style="margin: 10px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='#f0f8ff'; this.style.borderColor='#0078d7';" 
               onmouseout="this.style.background='white'; this.style.borderColor='#eee';"
               onclick="showItemConfirm(${item.id})">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <p style="margin: 0; font-weight: bold; color: #0078d7;">${item.name}</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${item.desc}</p>
                <p style="margin: 5px 0 0 0; font-size: 11px; color: #999;">
                  æ•ˆæœï¼š${getItemEffectText(item)}
                </p>
              </div>
              <div style="background: #0078d7; color: white; border-radius: 12px; padding: 4px 8px; font-size: 12px; min-width: 20px; text-align: center;">
                ${item.quantity}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      modal.style.display = "flex";
    }

    // å…³é—­æ‚ç‰©é—´å¯¹è¯æ¡†
    function closeItemsDialog() {
      const modal = document.getElementById("items-dialog-modal");
      modal.style.display = "none";
    }

    let currentItemToUse = null;

    // æ˜¾ç¤ºé“å…·ä½¿ç”¨ç¡®è®¤å¼¹çª—
    function showItemConfirm(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item || !player.inventory[itemId] || player.inventory[itemId] <= 0) {
        return;
      }
      
      currentItemToUse = itemId;
      const modal = document.getElementById("item-confirm-modal");
      const itemInfo = document.getElementById("modal-item-info");
      
      itemInfo.innerHTML = `
        <div style="text-align: center; margin-bottom: 10px;">
          <h4 style="margin: 0; color: #0078d7;">${item.name}</h4>
          <p style="margin: 5px 0; color: #666; font-size: 14px;">${item.desc}</p>
        </div>
        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
          <p style="margin: 0; font-size: 13px;"><strong>ä½¿ç”¨æ•ˆæœï¼š</strong>${getItemEffectText(item)}</p>
          <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">æ‹¥æœ‰æ•°é‡ï¼š${player.inventory[itemId]}</p>
        </div>
      `;
      
      // å…ˆå…³é—­æ‚ç‰©é—´å¯¹è¯æ¡†
      closeItemsDialog();
      // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
      modal.style.display = "flex";
    }

    // ç¡®è®¤ä½¿ç”¨é“å…·
    function confirmUseItem() {
      if (currentItemToUse === null) return;
      
      const item = items.find(i => i.id === currentItemToUse);
      if (!item) return;
      
      if (useItem(currentItemToUse)) {
        let message = `ä½¿ç”¨äº†${item.name}`;
        
        // ç‰¹æ®Šçš„ä½¿ç”¨æ•ˆæœæè¿°
        if (item.name === "æ¸¸æˆå¡å¸¦") {
          message += "ï¼Œæ²‰è¿·åœ¨ç²¾å½©çš„æ¸¸æˆä¸­ã€‚";
        } else if (item.name === "å’–å•¡è±†") {
          message += "ï¼Œå†²äº†ä¸€æ¯é¦™æµ“çš„å’–å•¡ã€‚";
        } else if (item.name === "æŒ‰æ‘©å™¨") {
          message += "ï¼ŒæŒ‰æ‘©ç¼“è§£äº†ç–²åŠ³ã€‚";
        } else if (item.name === "ç¼–ç¨‹ä¹¦ç±") {
          message += "ï¼Œå­¦åˆ°äº†æ–°çš„æŠ€æœ¯çŸ¥è¯†ã€‚";
        } else if (item.name === "è‚¥å®…å¿«ä¹æ°´") {
          message += "ï¼Œå–äº†ä¸€å£ï¼Œæ„Ÿè§‰æ— æ¯”å¿«ä¹ã€‚";
        } else if (item.name === "è›‹ç™½ç²‰") {
          message += "ï¼Œä¸‹æ¬¡å¥èº«æ•ˆæœä¼šæ›´å¥½ï¼";
        }
        
        // æ˜¾ç¤ºæ•ˆæœ
        let effects = [];
        if (item.energyGain) effects.push(`ä½“åŠ›+${item.energyGain}`);
        if (item.energyCost) effects.push(`ä½“åŠ›${item.energyCost}`);
        if (item.moodGain) effects.push(`å¿ƒæƒ…+${item.moodGain}`);
        if (item.skillGain) effects.push(`èƒ½åŠ›+${item.skillGain}`);
        if (item.special === "gym_bonus") effects.push(`è·å¾—å¥èº«åŠ æˆ`);
        
        let effectsText = effects.length > 0 ? effects.join('ï¼Œ') : null;
        
        showGamePopup("é“å…·ä½¿ç”¨æˆåŠŸ", message, effectsText, function() {
          updateStatusBox();
        });
      } else {
        showGamePopup("ä½¿ç”¨å¤±è´¥", "é“å…·ä½¿ç”¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
      }
      
      closeItemModal();
      currentItemToUse = null;
    }

    // å…³é—­é“å…·ç¡®è®¤å¼¹çª—
    function closeItemModal() {
      const modal = document.getElementById("item-confirm-modal");
      modal.style.display = "none";
      currentItemToUse = null;
    }

    // æ¸¸æˆå†…å¼¹çª—ç³»ç»Ÿ
    function showGamePopup(title, message, effects = null, onConfirm = null) {
      const popup = document.getElementById("game-popup");
      const titleEl = document.getElementById("popup-title");
      const messageEl = document.getElementById("popup-message");
      const effectsEl = document.getElementById("popup-effects");
      const okBtn = document.getElementById("popup-btn-ok");
      
      titleEl.textContent = title;
      messageEl.innerHTML = message;
      
      if (effects) {
        effectsEl.innerHTML = `<strong>æ•ˆæœå˜åŒ–ï¼š</strong>${effects}`;
        effectsEl.style.display = "block";
      } else {
        effectsEl.style.display = "none";
      }
      
      // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„å›è°ƒ
      okBtn.onclick = function() {
        closeGamePopup();
        if (onConfirm) onConfirm();
      };
      
      popup.style.display = "flex";
    }

    function closeGamePopup() {
      const popup = document.getElementById("game-popup");
      popup.style.display = "none";
    }

    // é”®ç›˜äº‹ä»¶å¤„ç†
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeItemsDialog();
        closeItemModal();
        closeGamePopup();
      }
    });

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    document.addEventListener('click', function(event) {
      const itemsModal = document.getElementById("items-dialog-modal");
      const itemConfirmModal = document.getElementById("item-confirm-modal");
      const gamePopup = document.getElementById("game-popup");
      
      if (event.target === itemsModal) {
        closeItemsDialog();
      }
      if (event.target === itemConfirmModal) {
        closeItemModal();
      }
      if (event.target === gamePopup) {
        closeGamePopup();
      }
    });

    function startGame() {
      const nameInput = document.getElementById("name-input").value;
      const birthMonth = parseInt(document.getElementById("birth-month").value);
      const birthDay = parseInt(document.getElementById("birth-day").value);
      
      if (!nameInput.trim()) {
        showGamePopup("æç¤º", "è¯·è¾“å…¥ä½ çš„å§“åæ‰èƒ½å¼€å§‹æ¸¸æˆï¼");
        return;
      }
      
      player.name = nameInput;
      player.birthMonth = birthMonth;
      player.birthDay = birthDay;
      
      // æ ¹æ®ç”Ÿæ—¥è®¡ç®—æ¸¸æˆå¼€å§‹æ—¥æœŸ
      gameDate = calculateGameStartDate(birthMonth, birthDay);
      
      // æ›´æ–°æ‰€æœ‰åŸºäºæ—¥æœŸçš„å±æ€§
      player.lastJobChange = new Date(gameDate);
      player.lastSalaryRaise = new Date(gameDate);
      player.lastHouseChange = new Date(gameDate);
      
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-screen").style.display = "block";
      document.getElementById("status-box").style.display = "block";
      
      // è¿›å…¥æ¢¦å¢ƒé€‰æ‹©
      showDreamChoice();
    }

    function resetGame() {
      // é‡ç½®æ¸¸æˆæ•°æ®
      player = {
        name: "",
        age: 22,
        birthMonth: 0,
        birthDay: 1,
        money: 10000,
        income: 8000,
        rent: 0,
        energy: 100,
        maxEnergy: 100,
        mood: 100,
        skill: 500,
        company: "å°å‹äº’è”ç½‘å…¬å¸",
        house: "",
        inventory: {}, // é‡ç½®åº“å­˜
        gymBonus: false, // é‡ç½®è›‹ç™½ç²‰çŠ¶æ€
        lastJobChange: new Date(2027, 0, 1), // ä¸´æ—¶æ—¥æœŸï¼Œå®é™…ä¼šåœ¨startGameä¸­é‡æ–°è®¡ç®—
        lastSalaryRaise: new Date(2027, 0, 1),
        lastHouseChange: new Date(2027, 0, 1),
        monthlyJobAttempts: 0, // æœ¬æœˆè·³æ§½å°è¯•æ¬¡æ•°
        lastJobAttemptMonth: 0 // ä¸Šæ¬¡è·³æ§½å°è¯•çš„æœˆä»½
      };
      gameDate = new Date(2027, 0, 1); // ä¸´æ—¶æ—¥æœŸï¼Œå®é™…ä¼šåœ¨startGameä¸­é‡æ–°è®¡ç®—
      hasPerfectAttendance = true;
      absentDays = 0;

      // é‡ç½®ç•Œé¢
      document.getElementById("name-input").value = "";
      document.getElementById("birth-month").value = "0";
      updateDayOptions(); // é‡ç½®æ—¥æœŸé€‰é¡¹
      document.getElementById("game-screen").style.display = "none";
      document.getElementById("start-screen").style.display = "block";
      document.getElementById("status-box").style.display = "none";
      document.getElementById("items-button").style.display = "none";
      
      // å…³é—­æ‰€æœ‰å¼¹çª—
      document.getElementById("items-dialog-modal").style.display = "none";
      document.getElementById("item-confirm-modal").style.display = "none";
      document.getElementById("game-popup").style.display = "none";
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ—¥æœŸé€‰é¡¹
    window.addEventListener('load', function() {
      updateDayOptions();
    });

    // æ¢¦å¢ƒé€‰æ‹©ç³»ç»Ÿ
    function showDreamChoice() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
          <p style="font-style: italic; color: #b8b8d4; margin-bottom: 15px;">ä½ åšäº†ä¸€ä¸ªæ¢¦...</p>
          <hr style="border-color: #444;">
          <p>åœ¨æœ¦èƒ§çš„æ¢¦å¢ƒä¸­ï¼Œä½ çœ‹åˆ°ä¸€ä¸ªé¢ç›®æ¨¡ç³Šçš„ç¥ç§˜äººå½±ã€‚</p>
          <p>é‚£äººç”¨ä½æ²‰çš„å£°éŸ³é—®ä½ ï¼š</p>
          <p style="color: #e6e6fa; font-weight: bold;">"ä½ æƒ³è¿‡æ€æ ·çš„äººç”Ÿï¼Ÿ"</p>
          <hr style="border-color: #444;">
          <p>ä½ çš„å›ç­”æ˜¯ï¼š</p>
          <button onclick="chooseDream('normal')" style="margin: 5px; padding: 10px 15px; background: #4a5568; color: white; border: none; border-radius: 5px; cursor: pointer;">æ™®æ™®é€šé€šå°±å¥½</button>
          <button onclick="chooseDream('random')" style="margin: 5px; padding: 10px 15px; background: #2d3748; color: white; border: none; border-radius: 5px; cursor: pointer;">éšä¾¿å§</button>
        </div>
      `;
    }

    function chooseDream(choice) {
      const gameScreen = document.getElementById("game-screen");
      
      if (choice === 'normal') {
        // æ™®é€šå¼€å±€ - ä¿æŒé»˜è®¤è®¾ç½®
        gameScreen.innerHTML = `
          <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
            <p>ä½ å›ç­”<span style="color: #90cdf4;">"æ™®æ™®é€šé€šå°±å¥½"</span>åï¼Œé‚£äººç‚¹äº†ç‚¹å¤´ï¼Œçªç„¶æ¶ˆå¤±ä¸è§äº†ã€‚</p>
            <hr style="border-color: #444;">
            <p style="font-style: italic; color: #b8b8d4;">æ¢¦å¢ƒæ¸æ¸æ•£å»...</p>
            <button onclick="finishDream()" style="margin-top: 15px; padding: 10px 20px; background: #4a5568; color: white; border: none; border-radius: 5px; cursor: pointer;">é†’æ¥</button>
          </div>
        `;
      } else if (choice === 'random') {
        // éšæœºå¼€å±€ - éšæœºåŒ–å±æ€§
        const randomIncome = Math.floor(Math.random() * (10000 - 6000 + 1)) + 6000; // 6000-10000
        const randomMoney = Math.floor(Math.random() * (20000 - 3500 + 1)) + 3500;   // 3500-20000

        player.income = randomIncome;
        player.money = randomMoney;
        
        gameScreen.innerHTML = `
          <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
            <p>ä½ å›ç­”<span style="color: #fbb6ce;">"éšä¾¿å§"</span>åï¼Œé‚£äººç‚¹äº†ç‚¹å¤´ï¼Œçªç„¶æ¶ˆå¤±ä¸è§äº†ã€‚</p>
            <p style="color: #a78bfa;">åœ¨ä»–æ¶ˆå¤±çš„ç¬é—´ï¼Œä½ æ„Ÿåˆ°ä¸€è‚¡å¥‡å¼‚çš„åŠ›é‡æ¶Œå…¥ä½“å†…...</p>
            <hr style="border-color: #444;">
            <p style="font-style: italic; color: #b8b8d4;">æ¢¦å¢ƒæ¸æ¸æ•£å»...</p>
            <p style="color: #68d391; font-size: 12px;">ä½ æ„Ÿè§‰åˆ°å‘½è¿å‘ç”Ÿäº†å¾®å¦™çš„å˜åŒ–</p>
            <button onclick="finishDream()" style="margin-top: 15px; padding: 10px 20px; background: #553c9a; color: white; border: none; border-radius: 5px; cursor: pointer;">é†’æ¥</button>
          </div>
        `;
      }
    }

    function finishDream() {
      updateStatusBox();
      showIntro();
    }

    function showIntro() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ å« <b>${player.name}</b>ï¼Œä»Šå¹´ 22 å²ï¼Œæœ¬ç§‘æ¯•ä¸šåæ¥åˆ°åŒ—äº¬ï¼Œå¼€å§‹äº†åŒ—æ¼‚ç”Ÿæ´»ã€‚</p>
        <p>ä½ åœ¨ä¸€å®¶äº’è”ç½‘å°å‚å·¥ä½œï¼Œæœˆæ”¶å…¥ <b>${player.income}</b> å…ƒã€‚</p>
        <p>èµ–äºçˆ¶æ¯çš„èµ„åŠ©å’Œä½ è‡ªå·±æ”’çš„èµ„é‡‘ï¼Œä½ å½“å‰çš„å­˜æ¬¾æ˜¯ <b>${player.money}</b> å…ƒã€‚</p>
        <p>ä»Šå¤©æ˜¯ä½ å…¥èŒå…¬å¸çš„ç¬¬ä¸€å¤©ã€‚å¥½å·§ï¼Œä»Šå¤©ä¹Ÿæ˜¯ä½ çš„ç”Ÿæ—¥ã€‚</p>
        <p>å¯æƒœæ²¡æœ‰æ—¶é—´åº†ç¥ï¼Œæ‘†åœ¨ä½ çœ¼å‰çš„è¿˜æœ‰è®¸å¤šé—®é¢˜ã€‚</p>
        <p>ç­‰ç¨³å®šä¸‹æ¥ä¸€å®šè¦ç»™è‡ªå·±å¥½å¥½è¿‡ä¸€ä¸ªç”Ÿæ—¥ï¼Œä½ æš—æš—æƒ³ç€ã€‚</p>
        <p>æ²¡æ—¶é—´å¤šæƒ³äº†ï¼Œä½ å¾—èµ¶ç´§å»å…¬å¸æŠ¥é“ã€‚</p>
        <button onclick="goOutBeforeWork()">å‡ºé—¨</button>
      `;
    }

    function goOutBeforeWork() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>å‡ºé—¨ä¹‹å‰ï¼Œä½ æ‰«è§†äº†å‡ºç§Ÿå±‹ï¼Œå›æƒ³èµ·äº†ä¸€ä¸ªæœˆå‰ç§Ÿæˆ¿çš„æƒ…æ™¯</p>
        <button onclick="chooseInitialHouse()">å›æƒ³</button>
      `;
    }

    function chooseInitialHouse() {
      const gameScreen = document.getElementById("game-screen");
      const outerRingHouses = houses.filter(h => h.name.includes("äº”ç¯å¤–"));
      
      gameScreen.innerHTML = `
        <p style="color:#999; font-style:italic; text-align:center; margin-bottom:15px;">â€”â€”â€” ä¸€ä¸ªæœˆå‰çš„å›å¿† â€”â€”â€”</p>
        <p>ä½ åœ¨ç§Ÿæˆ¿appä¸Šæœç´¢ç€é€‚åˆçš„æˆ¿æº...</p>
        <p style="color:#666; font-style:italic;">"ç°åœ¨æ²¡é’±ï¼Œå…¬å¸ä¹ŸæŒºåçš„ï¼Œå°±è¿™ä¸ªåœ°æ®µå¥½äº†......"</p>
        <hr>
        <p>ä½ æ‰¾åˆ°äº†ä»¥ä¸‹å‡ ä¸ªäº”ç¯å¤–çš„æˆ¿æºï¼š</p>
        ${outerRingHouses.map(h => `
          <div style="margin: 10px 0; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; text-align: left; background: rgba(240, 240, 240, 0.5); filter: blur(0.5px); opacity: 0.8;">
            <p><b>${h.name}</b> - ${h.desc}</p>
            <p>æœˆç§Ÿï¼š${h.rent}å…ƒ</p>
            <p style="font-size:12px; color:#666;">
              ç¡è§‰åŠ æˆï¼šä½“åŠ›+${30 + h.sleepEnergyBonus}ï¼Œå¿ƒæƒ…+${10 + h.sleepMoodBonus} | 
              æ¸¸æˆåŠ æˆï¼šå¿ƒæƒ…+${15 + h.gameMoodBonus}
            </p>
            <button onclick="selectInitialHouse('${h.name}', ${h.rent})" style="opacity: 1; filter: none;">é€‰æ‹©è¿™é‡Œ</button>
          </div>
        `).join('')}
      `;
    }

    function selectInitialHouse(houseName, houseRent) {
      player.house = houseName;
      player.rent = houseRent;
      player.money -= houseRent * 2; // æ”¯ä»˜æŠ¼é‡‘å’Œé¦–æœˆæˆ¿ç§Ÿ
      
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        
        <p>æœ€ç»ˆæŒ‘æŒ‘æ‹£æ‹£ï¼Œä½ é€‰æ‹©äº†<b>${houseName}</b>ï¼Œæœˆç§Ÿ <b>${houseRent}</b> å…ƒã€‚</p>
        <p>æ”¯ä»˜äº†æŠ¼é‡‘å’Œé¦–æœˆæˆ¿ç§Ÿå…± <b>${houseRent * 2}</b> å…ƒã€‚</p>
        <p>å½“å‰å­˜æ¬¾ï¼š<b>${player.money}</b> å…ƒã€‚</p>
        <p>æˆ¿å­ç¯å¢ƒä¸€èˆ¬ï¼Œç¦»å…¬å¸ä¹Ÿè¿œï¼Œåªèƒ½è¯´æ˜¯æƒå®œä¹‹è®¡ã€‚</p>
        <p style="color:#999; font-style:italic; text-align:center;">â€”â€”â€”â€”â€”â€”â€” å›å¿†ç»“æŸ â€”â€”â€”â€”â€”â€”â€”</p>
        <p>ä½†ç°åœ¨ä¸æ˜¯æƒ³è¿™äº›çš„æ—¶å€™äº†ã€‚</p>
        <p>å¾—èµ¶ç´§å»å…¬å¸æŠ¥é“äº†ï¼Œè¿Ÿåˆ°å¯ä¸å¥½ã€‚</p>
        <p>ä»¥åæœ‰é’±äº†å†ç§Ÿä¸ªå¥½ä¸€ç‚¹çš„æˆ¿å­å§ï¼Œè‡³äºä»€ä¹ˆæ—¶å€™èƒ½ä¹°å¾—èµ·è‡ªå·±çš„æˆ¿å­â€¦â€¦ä½ æ‘‡äº†æ‘‡å¤´ï¼Œä¸å†å»æƒ³ã€‚</p>
        <button onclick="goToWork()">å‡ºé—¨ä¸Šç­</button>
      `;
      updateStatusBox();
    }

    // ç¬¬ä¸€å¤©å¼ºåˆ¶ä¸Šç­å‡½æ•°
    function goToWork() {
      const gameScreen = document.getElementById("game-screen");
      
      // ç¬¬ä¸€å¤©å¿…é¡»ä¸Šç­ï¼Œæ˜¾ç¤ºç‰¹æ®Šå‰§æƒ…
      resetChanges();
      applyChange('energy', -5);
      applyChange('mood', -5);
      applyChange('skill', 5);
      
      gameScreen.innerHTML = `
        <p><b>ç¬¬ä¸€å¤©ä¸Šç­</b></p>
        <hr>
        <p>ä½ æ€€ç€å¿å¿‘ä¸å®‰çš„å¿ƒæƒ…æ¥åˆ°å…¬å¸æ¥¼ä¸‹ï¼ŒæŠ¬å¤´æœ›ç€è¿™æ ‹å¹¶ä¸ç®—é«˜çš„å†™å­—æ¥¼ã€‚</p>
        <p>"å°±æ˜¯è¿™é‡Œäº†..."ä½ æ·±å¸ä¸€å£æ°”ï¼Œèµ°è¿›äº†å¤§å…ã€‚</p>
        <p>å‰å°å°å§å§å¾ˆçƒ­æƒ…åœ°ä¸ºä½ åŠç†äº†å…¥èŒæ‰‹ç»­ï¼Œç»™äº†ä½ å·¥ç‰Œå’Œä¸´æ—¶ç”µè„‘å¯†ç ã€‚</p>
        <p>ä½ è¢«åˆ†é…åˆ°äº†å¼€å‘éƒ¨ï¼Œååœ¨äº†ä¸€ä¸ªé çª—çš„ä½ç½®ã€‚è™½ç„¶æ˜¯å°å…¬å¸ï¼Œä½†åŒäº‹ä»¬çœ‹èµ·æ¥éƒ½å¾ˆå‹å–„ã€‚</p>
        <p>ç»„é•¿ç»™ä½ ä»‹ç»äº†å·¥ä½œå†…å®¹å’Œé¡¹ç›®æƒ…å†µï¼Œè™½ç„¶æŠ€æœ¯æ ˆæœ‰äº›é™Œç”Ÿï¼Œä½†ä½ è§‰å¾—è‡ªå·±èƒ½å¤Ÿèƒœä»»ã€‚</p>
        <p>"æ–°äººå˜›ï¼Œæ…¢æ…¢æ¥ï¼Œä¸è¦æœ‰å‹åŠ›ã€‚"ç»„é•¿æ‹äº†æ‹ä½ çš„è‚©è†€è¯´é“ã€‚</p>
        <p>ç¬¬ä¸€å¤©ä¸»è¦æ˜¯ç†Ÿæ‚‰ç¯å¢ƒå’Œä»£ç ï¼Œè™½ç„¶æœ‰äº›ç´§å¼ ï¼Œä½†æ€»ä½“æ¥è¯´è¿˜ç®—é¡ºåˆ©ã€‚</p>
        <hr>
        <p style="color:#666; font-size:14px;"><b>ä½“åŠ› -5ï¼Œå¿ƒæƒ… -5ï¼Œèƒ½åŠ› +5</b></p>
        <button onclick="firstDayEnd()">ä¸‹ç­å›å®¶</button>
      `;
      
      updateStatusBox();
    }

    // ç¬¬ä¸€å¤©ç»“æŸå‡½æ•°
    function firstDayEnd() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ æ‹–ç€ç–²æƒ«çš„èº«ä½“å›åˆ°äº†ç§Ÿä½çš„æˆ¿é—´ã€‚</p>
        <p>è™½ç„¶ç¬¬ä¸€å¤©æœ‰äº›ç´§å¼ ï¼Œä½†æ€»ç®—æ˜¯é¡ºåˆ©åº¦è¿‡äº†ã€‚</p>
        <p>"åŒ—æ¼‚ç”Ÿæ´»ï¼Œæ­£å¼å¼€å§‹äº†..."ä½ çœ‹ç€çª—å¤–çš„å¤œæ™¯ï¼Œå¿ƒä¸­äº”å‘³æ‚é™ˆã€‚</p>
        <hr>
        <p>ä»æ˜å¤©å¼€å§‹ï¼Œä½ éœ€è¦è‡ªå·±è§„åˆ’æ¯ä¸€å¤©çš„ç”Ÿæ´»ã€‚</p>
        <button onclick="finishIntro()">å¼€å§‹æ–°çš„ä¸€å¤©</button>
      `;
      nextDay();
      updateStatusBox(); // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºæ–°çš„æ—¥æœŸ
    }

    function finishIntro() {
      nextStep();
    }

    function nextDay() {
      gameDate.setDate(gameDate.getDate() + 1);
      checkBirthday();
      if (gameDate.getDate() === 1) {
        settleSalary();
      }
    }

    function checkBirthday() {
      const today = gameDate;
      if (today.getMonth() === player.birthMonth && today.getDate() === player.birthDay) {
        player.age++;
        handleBirthdayEvent();
      }
    }

    function handleBirthdayEvent() {
      if (player.age === 23) {
        // 23å²ç”Ÿæ—¥ç‰¹æ®Šäº‹ä»¶
        player.money += 2000;
        player.mood = Math.min(100, player.mood + 30);
        
        showGamePopup(
          "ğŸ‚ ç”Ÿæ—¥å¿«ä¹ï¼", 
          `ä»Šå¤©æ˜¯ä½ çš„${player.age}å²ç”Ÿæ—¥ï¼<br><br>ğŸ“± å¾®ä¿¡æ¶ˆæ¯ä¸æ–­å¼¹å‡º...<br><br>"å„¿å­ç”Ÿæ—¥å¿«ä¹ï¼å¦ˆå¦ˆç»™ä½ å‘äº†2000å—é’±çº¢åŒ…ï¼Œè®°å¾—æ”¶ä¸€ä¸‹~"<br><br>"ç”Ÿæ—¥å¿«ä¹å•Šï¼Œå°å­éƒ½23äº†ï¼Œä»€ä¹ˆæ—¶å€™å¸¦ä¸ªå¥³æœ‹å‹å›å®¶ï¼Ÿéš”å£è€ç‹å®¶çš„å­©å­éƒ½è®¢å©šäº†..."<br><br>çœ‹ç€çˆ¶æ¯çš„å…³å¿ƒå’Œ"å‚¬å©š"ï¼Œä½ å¿ƒæƒ…å¤æ‚ä½†ä¹Ÿå¾ˆæ¸©æš–ã€‚`, 
          "å¹´é¾„+1ï¼Œé‡‘é’±+2000ï¼Œå¿ƒæƒ…+30"
        );
      } else {
        // æ™®é€šç”Ÿæ—¥
        player.mood = Math.min(100, player.mood + 20);
        let birthdayMessages = [
          `ä»Šå¤©æ˜¯ä½ çš„${player.age}å²ç”Ÿæ—¥ï¼è™½ç„¶ç‹¬è‡ªåœ¨åŒ—äº¬ï¼Œä½†è¿˜æ˜¯è¦åº†ç¥ä¸€ä¸‹ã€‚`,
          `${player.age}å²ç”Ÿæ—¥å¿«ä¹ï¼æ—¶é—´è¿‡å¾—çœŸå¿«ï¼Œåˆé•¿å¤§äº†ä¸€å²ã€‚`,
          `ç”Ÿæ—¥å¿«ä¹ï¼${player.age}å²çš„ä½ åœ¨åŒ—äº¬ç»§ç»­å¥‹æ–—ç€ã€‚`
        ];
        
        showGamePopup(
          "ğŸ‚ ç”Ÿæ—¥å¿«ä¹ï¼", 
          birthdayMessages[Math.floor(Math.random() * birthdayMessages.length)], 
          `å¹´é¾„+1ï¼Œå¿ƒæƒ…+20`
        );
      }
    }

    function settleSalary() {
      const workDaysInMonth = 26;
      let bonus = hasPerfectAttendance ? Math.floor(player.income * 0.25) : 0;
      let dailySalary = Math.floor(player.income / workDaysInMonth);
      let actualWorkDays = workDaysInMonth - absentDays;
      actualWorkDays = Math.max(0, actualWorkDays);
      let actualSalary = dailySalary * actualWorkDays;

      player.money += actualSalary + bonus - player.rent;
      updateStatusBox();

      let message = `æœ¬æœˆå·¥ä½œ${actualWorkDays}å¤©<br>å®å‘å·¥èµ„ï¼š${actualSalary}å…ƒ<br>å…¨å‹¤å¥–ï¼š${bonus}å…ƒ<br>æ‰£é™¤æˆ¿ç§Ÿï¼š${player.rent}å…ƒ`;
      let effectsText = `é‡‘é’±+${actualSalary + bonus - player.rent}`;
      
      showGamePopup("ğŸ’° æœˆåº•ç»“ç®—", message, effectsText);
      hasPerfectAttendance = true;
      absentDays = 0;
    }

    function nextStep() {
      const gameScreen = document.getElementById("game-screen");
      const day = gameDate.getDay();

      if (player.energy < 0) {
        gameScreen.innerHTML = `
          <h3>æ¸¸æˆç»“æŸ</h3>
          <p>æ—¶é—´ï¼š<b>${getDateString()}</b></p>
          <p>ä¸»è§’å­˜æ¬¾ï¼š<b>${player.money}</b> å…ƒ</p>
          <p style="color:#C1437A;font-weight:bold;">èº«ä½“æ˜¯é©å‘½çš„æœ¬é’±</p>
          <button onclick="resetGame()" style="margin-top: 20px;">é‡æ–°å¼€å§‹</button>
        `;
        return;
      }

      let optionsHtml = '';
      if (day === 0) {
        optionsHtml = '<button onclick="restMenu()">åœ¨å®¶ä¼‘æ¯</button>';
      } else {
        optionsHtml = '<button onclick="chooseWork()">å»å…¬å¸ä¸Šç­</button>' +
                      '<button onclick="restMenu()">åœ¨å®¶ä¼‘æ¯</button>';
      }

      gameScreen.innerHTML = `
        <p>ä»Šå¤©æ˜¯ <b>${getDateString()}</b>ã€‚</p>
        <p>ä»Šå¤©ä½ æƒ³ï¼š</p>
        ${optionsHtml}
      `;
    }

    // ä¸Šç­é€»è¾‘
    function chooseWork() {
      const day = gameDate.getDay();
      let message = "";
      let statusText = "";

      if (day === 0) {
        message = "ä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œå…¬å¸ä¼‘æ¯ã€‚";
      } else {
        resetChanges();
        applyChange('energy', -5);
        applyChange('mood', -5);
        
        if (player.mood === 0) {
          // å¿ƒæƒ…é™åˆ°0æ—¶ï¼Œæ‘¸é±¼æ¨¡å¼
          message = "ä½ å®Œå…¨æä¸èµ·ç²¾ç¥ï¼Œæ•´å¤©éƒ½åœ¨åˆ’æ°´æ‘¸é±¼ã€‚";
        } else if (player.mood < 20) {
          // å¿ƒæƒ…å¾ˆä½æ—¶ï¼Œæœ‰å¯èƒ½è¢«ä¸»ç®¡è´£éª‚
          if (Math.random() < 0.5) {
            message = "ä½ å¿ƒä¸åœ¨ç„‰ï¼Œä¸Šç­æ—¶è¢«ä¸»ç®¡éª‚äº†ä¸€é¡¿ï¼Œå¿ƒæƒ…æ›´åŠ ç³Ÿç³•ã€‚";
            applyChange('mood', -10);
            applyChange('skill', 1);
          } else {
            message = "ä½ å‹‰å¼ºå®Œæˆäº†å·¥ä½œï¼Œæ•ˆç‡å¾ˆä½ã€‚";
            applyChange('skill', 2);
          }
        } else {
          // æ­£å¸¸å·¥ä½œ
          message = "ä½ åŠªåŠ›å·¥ä½œäº†ä¸€å¤©ï¼Œç§¯ç´¯äº†ä¸€äº›ç»éªŒã€‚";
          applyChange('skill', 5);
          if (Math.random() < 0.1) {  // 10%æ¦‚ç‡è·å¾—é¢å¤–æˆé•¿
            message += "ä»Šå¤©é‡åˆ°äº†ä¸€ä¸ªæŠ€æœ¯éš¾é¢˜ï¼Œä½†è¢«ä½ è§£å†³äº†ï¼å¿ƒæƒ…ä¸é”™ï¼";
            applyChange('skill', 3);
            applyChange('mood', 5); // è§£å†³éš¾é¢˜æ—¶å¢åŠ å¿ƒæƒ…
          }
        }

        statusText = `<p><b>ä½“åŠ› -5ï¼Œå¿ƒæƒ… ${changes.mood > 0 ? '+' + changes.mood : changes.mood}${changes.skill > 0 ? 'ï¼Œèƒ½åŠ› +' + changes.skill : ''}</b></p>`;
      }

      nextDay();
      updateStatusBox();
      document.getElementById("game-screen").innerHTML = `
        <p>${message}</p>
        ${statusText}
        <button onclick="nextStep()">ç»§ç»­</button>
      `;
    }

    // äºŒçº§ä¼‘æ¯èœå•
    function restMenu() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ å†³å®šåœ¨å®¶ä¼‘æ¯ï¼Œå¯ä»¥é€‰æ‹©ï¼š</p>
        <button onclick="restSleep()">ç¡ä¸€è§‰</button>
        <button onclick="restGame()">åœ¨å®¶æ‰“æ¸¸æˆ</button>
        <button onclick="readForum()">çœ‹è®ºå›</button>
        <button onclick="goOutMenu()">å‡ºå»èµ°èµ°</button>
      `;
    }

    function readForum() {
      resetChanges();
      applyChange('skill', 3);
      applyChange('mood', 10);
      handleAbsence();

      let events = [
        "ä½ åœ¨è®ºå›ä¸Šçœ‹åˆ°äº†ä¸€äº›æœ‰è¶£çš„æŠ€æœ¯è®¨è®ºï¼Œå­¦åˆ°äº†æ–°çŸ¥è¯†ã€‚",
        "ä½ å‘ç°äº†ä¸€ä¸ªå¾ˆå¥½çš„æŠ€æœ¯æ•™ç¨‹ï¼Œè®¤çœŸå­¦ä¹ äº†ä¸€ä¸‹åˆã€‚",
        "ä½ åœ¨è®ºå›ä¸Šå’Œå…¶ä»–ç¨‹åºå‘˜äº¤æµï¼Œè·å¾—äº†ä¸€äº›æ–°çš„è§è§£ã€‚"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      endDay(message, changes);
    }

    function restSleep() {
      resetChanges();
      const currentHouse = houses.find(h => h.name === player.house);
      const moodBonus = currentHouse ? currentHouse.sleepMoodBonus : 0;
      const energyBonus = currentHouse ? currentHouse.sleepEnergyBonus : 0;
      
      applyChange('energy', 30 + energyBonus);
      applyChange('mood', 10 + moodBonus);
      handleAbsence();
      
      let message = "ä½ ç¾ç¾åœ°ç¡äº†ä¸€è§‰ï¼Œç²¾ç¥æ¢å¤äº†ä¸å°‘ã€‚";
      if (currentHouse) {
        if (moodBonus > 0 || energyBonus > 0) {
          message += `èˆ’é€‚çš„å±…ä½ç¯å¢ƒè®©ä½ ç¡å¾—æ›´é¦™ç”œï¼`;
        } else if (moodBonus < 0 || energyBonus < 0) {
          message += `ç³Ÿç³•çš„ç¯å¢ƒå½±å“äº†ä½ çš„ç¡çœ è´¨é‡...`;
        }
      }
      
      endDay(message, changes);
    }

    function restGame() {
      resetChanges();
      const currentHouse = houses.find(h => h.name === player.house);
      const moodBonus = currentHouse ? currentHouse.gameMoodBonus : 0;
      
      applyChange('energy', 10);
      applyChange('mood', 15 + moodBonus);
      handleAbsence();
      
      let message = "ä½ åœ¨å®¶æ‰“äº†ä¸€å¤©æ¸¸æˆï¼Œè™½ç„¶æœ‰ç‚¹å®…ï¼Œä½†å¿ƒæƒ…å¥½å¤šäº†ã€‚";
      if (currentHouse) {
        if (moodBonus > 0) {
          message += `èˆ’é€‚çš„ç¯å¢ƒè®©æ¸¸æˆä½“éªŒæ›´æ£’ï¼`;
        } else if (moodBonus < 0) {
          message += `ç³Ÿç³•çš„ç¯å¢ƒè®©ä½ æœ‰äº›çƒ¦èº...`;
        }
      }
      
      endDay(message, changes);
    }

    function goOutMenu() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ å†³å®šå‡ºå»èµ°èµ°ï¼Œå»å“ªé‡Œå‘¢ï¼Ÿ</p>
        <button onclick="goPark()">å…¬å›­</button>
        <button onclick="goNetCafe()">ç½‘å§</button>
        <button onclick="goMall()">å•†åœº</button>
        <button onclick="goGym()">å¥èº«æˆ¿</button>
        <button onclick="goBackHome()">è¿˜æ˜¯å›å®¶å§</button>
      `;
    }

    function goGym() {
      resetChanges();
      applyChange('money', -100);
      applyChange('energy', -20);
      
      // åŸºç¡€ä½“åŠ›ä¸Šé™å¢åŠ 
      let maxEnergyGain = 1;
      // å¦‚æœæœ‰è›‹ç™½ç²‰åŠ æˆï¼Œé¢å¤–+1
      if (player.gymBonus) {
        maxEnergyGain += 1;
        player.gymBonus = false; // ä½¿ç”¨åæ¸…é™¤åŠ æˆ
      }
      applyChange('maxEnergy', maxEnergyGain);
      applyChange('mood', 15);
      handleAbsence();

      let events = [
        "ä½ è¿›è¡Œäº†ä¸€æ¬¡å……å®çš„å¥èº«è®­ç»ƒï¼Œè™½ç„¶å¾ˆç´¯ä½†æ„Ÿè§‰å¾ˆæ£’ã€‚",
        "å¥èº«è®©ä½ æ„Ÿè§‰å……æ»¡æ´»åŠ›ï¼Œå¯¹ç”Ÿæ´»æ›´æœ‰ä¿¡å¿ƒäº†ã€‚",
        "ä½ é‡åˆ°äº†å‡ ä¸ªå¿—åŒé“åˆçš„å¥èº«ä¼™ä¼´ï¼Œäº’ç›¸åŠ æ²¹æ‰“æ°”ã€‚"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (maxEnergyGain > 1) {
        message += "è›‹ç™½ç²‰å‘æŒ¥äº†ä½œç”¨ï¼Œè®­ç»ƒæ•ˆæœæ ¼å¤–æ˜¾è‘—ï¼";
      }
      
      endDay(message, changes);
    }

    function goBackHome() {
      // æ¶ˆè€—ä½“åŠ›å¹¶æ˜¾ç¤ºå¼¹çª—è¯´æ˜
      resetChanges();
      applyChange('energy', -5); // å‡ºé—¨ä¸€è¶Ÿç¨å¾®æ¶ˆè€—ç‚¹ä½“åŠ›
      updateStatusBox(); // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      
      showGamePopup("ğŸ  å›åˆ°å®¶ä¸­", "çªç„¶æƒ³èµ·æ¥ç…¤æ°”è¿˜æ²¡å…³ã€‚", "ä½“åŠ›-5", function() {
        restMenu(); // å›åˆ°ä¼‘æ¯èœå•
      });
    }

    function useItemMenu() {
      const gameScreen = document.getElementById("game-screen");
      
      // è·å–ç©å®¶æ‹¥æœ‰çš„é“å…·
      let ownedItems = [];
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          const item = items.find(i => i.id == itemId);
          if (item) {
            ownedItems.push({...item, quantity: player.inventory[itemId]});
          }
        }
      }
      
      if (ownedItems.length === 0) {
        gameScreen.innerHTML = `
          <p>ä½ çš„èƒŒåŒ…é‡Œæ²¡æœ‰ä»»ä½•é“å…·ã€‚</p>
          <p>å»å•†åœºä¹°ä¸€äº›æœ‰ç”¨çš„é“å…·å§ï¼</p>
          <button onclick="restMenu()">è¿”å›</button>
        `;
        return;
      }
      
      gameScreen.innerHTML = `
        <p>ä½ çš„é“å…·èƒŒåŒ…ï¼š</p>
        <div style="max-height: 300px; overflow-y: auto;">
          ${ownedItems.map(item => `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
              <p><b>${item.name}</b> x${item.quantity}</p>
              <p>${item.desc}</p>
              <p style="font-size:12px; color:#666;">
                æ•ˆæœï¼š${getItemEffectText(item)}
              </p>
              <button onclick="useItemAndShow(${item.id})">ä½¿ç”¨</button>
            </div>
          `).join('')}
        </div>
        <hr>
        <button onclick="restMenu()">è¿”å›</button>
      `;
    }

    function useItemAndShow(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item) return;
      
      if (useItem(itemId)) {
        let message = `ä½ ä½¿ç”¨äº†${item.name}ã€‚${item.desc}`;
        
        // ç‰¹æ®Šçš„ä½¿ç”¨æ•ˆæœæè¿°
        if (item.name === "æ¸¸æˆå¡å¸¦") {
          message = "ä½ æ²‰è¿·åœ¨æ¸¸æˆçš„ç²¾å½©å‰§æƒ…ä¸­ï¼Œè™½ç„¶æœ‰äº›ç´¯ä½†å¿ƒæƒ…å¾ˆå¥½ã€‚";
        } else if (item.name === "å’–å•¡è±†") {
          message = "ä½ å†²äº†ä¸€æ¯é¦™æµ“çš„å’–å•¡ï¼Œç¬é—´ç²¾ç¥äº†ä¸å°‘ã€‚";
        } else if (item.name === "æŒ‰æ‘©å™¨") {
          message = "æŒ‰æ‘©å™¨ç¼“è§£äº†ä½ çš„ç–²åŠ³ï¼Œæ•´ä¸ªäººéƒ½æ”¾æ¾äº†ã€‚";
        } else if (item.name === "ç¼–ç¨‹ä¹¦ç±") {
          message = "ä½ è®¤çœŸé˜…è¯»äº†ç¼–ç¨‹ä¹¦ç±ï¼Œå­¦åˆ°äº†ä¸€äº›æ–°çš„æŠ€æœ¯çŸ¥è¯†ã€‚";
        } else if (item.name === "å¥åº·é›¶é£Ÿ") {
          message = "ç¾å‘³çš„é›¶é£Ÿè®©ä½ å¿ƒæƒ…æ„‰æ‚¦ã€‚";
        } else if (item.name === "è›‹ç™½ç²‰") {
          message = "å¥½å–çš„è›‹ç™½ç²‰ï¼Œå–å®Œä¸ä¼šå¤´é¡¶å°–å°–ã€‚";
        }
        
        handleAbsence();
        endDay(message, changes);
      } else {
        alert("ä½¿ç”¨å¤±è´¥ï¼");
      }
    }

    function goPark() {
      resetChanges();
      applyChange('energy', 5);
      
      let events = [
        "ä½ åœ¨å…¬å›­é‡Œæ•£æ­¥ï¼Œå¿ƒæƒ…æ”¾æ¾äº†è®¸å¤šã€‚",
        "ä½ é‡åˆ°ä¸€ä¸ªè€åŒå­¦ï¼ŒèŠäº†å¾ˆä¹…ã€‚",
        "çªç„¶ä¸‹é›¨äº†ï¼Œä½ è¢«æ·‹æ¹¿ï¼Œå¿ƒæƒ…é™ä½ã€‚"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("æ·‹æ¹¿")) {
        applyChange('mood', -10);
      } else {
        applyChange('mood', 25);
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function goNetCafe() {
      resetChanges();
      applyChange('money', -100);
      applyChange('mood', 40);
      
      let events = [
        "ä½ åœ¨ç½‘å§ç©å¾—å¾ˆå¼€å¿ƒï¼Œç»“è¯†äº†å‡ ä¸ªæ–°æœ‹å‹ã€‚",
        "ä½ é€šå®µæ‰“æ¸¸æˆï¼Œç¬¬äºŒå¤©ç²¾ç¥çŠ¶æ€å¾ˆå·®ã€‚"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("é€šå®µ")) {
        applyChange('energy', -30);  // é€šå®µå‡å°‘30ç‚¹ä½“åŠ›
      } else {
        applyChange('energy', -10);  // æ­£å¸¸å‡å°‘10ç‚¹ä½“åŠ›
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function goMall() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ æ¥åˆ°äº†å•†åœºï¼Œè¿™é‡Œæœ‰å¾ˆå¤šåº—é“º...</p>
        <button onclick="mallShopping()">è´­ä¹°æ—¥ç”¨å“</button>
        <button onclick="mallItemStore()">é“å…·å•†åº—</button>
        <button onclick="mallRandomEvent()">éšä¾¿é€›é€›</button>
        <button onclick="goOutMenu()">è¿”å›</button>
      `;
    }

    function mallShopping() {
      resetChanges();
      applyChange('money', -200);
      applyChange('energy', -15);
      
      let events = [
        "ä½ åœ¨å•†åœºä¹°åˆ°äº†æ‰“æŠ˜å¥½è´§ï¼Œå¾ˆå¼€å¿ƒã€‚",
        "ä½ å†²åŠ¨æ¶ˆè´¹ï¼Œå›å®¶åæœ‰ç‚¹åæ‚”ã€‚"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("åæ‚”")) {
        applyChange('mood', -10);
      } else {
        applyChange('mood', 30);
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function mallRandomEvent() {
      resetChanges();
      applyChange('energy', -10);
      applyChange('mood', 15);
      handleAbsence();
      
      let message = "ä½ åœ¨å•†åœºé‡Œé—²é€›ï¼Œçœ‹äº†çœ‹å„ç§å•†å“ï¼Œå¿ƒæƒ…è¿˜ä¸é”™ã€‚";
      endDay(message, changes);
    }

    function mallItemStore() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>æ¬¢è¿æ¥åˆ°é“å…·å•†åº—ï¼ä½ å¯ä»¥è´­ä¹°å„ç§æœ‰ç”¨çš„ç‰©å“ï¼š</p>
        <div style="max-height: 300px; overflow-y: auto;">
          ${items.map(item => `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
              <p><b>${item.name}</b> - ${item.desc}</p>
              <p>ä»·æ ¼ï¼š${item.price}å…ƒ</p>
              <p style="font-size:12px; color:#666;">
                æ•ˆæœï¼š${getItemEffectText(item)}
              </p>
              <button onclick="buyItem(${item.id})" ${player.money < item.price ? 'disabled style="background:#999"' : ''}>
                ${player.money < item.price ? 'é‡‘é’±ä¸è¶³' : 'è´­ä¹°'}
              </button>
            </div>
          `).join('')}
        </div>
        <hr>
        <button onclick="goMall()">è¿”å›å•†åœº</button>
      `;
    }

    function getItemEffectText(item) {
      let effects = [];
      if (item.energyGain) effects.push(`ä½“åŠ›+${item.energyGain}`);
      if (item.energyCost) effects.push(`ä½“åŠ›${item.energyCost}`);
      if (item.moodGain) effects.push(`å¿ƒæƒ…+${item.moodGain}`);
      if (item.skillGain) effects.push(`èƒ½åŠ›+${item.skillGain}`);
      if (item.maxEnergyGain) effects.push(`æœ€å¤§ä½“åŠ›+${item.maxEnergyGain}`);
      if (item.special === "gym_bonus") effects.push(`ä¸‹æ¬¡å¥èº«æ—¶ä½“åŠ›ä¸Šé™é¢å¤–+1`);
      return effects.join('ï¼Œ') || 'ç‰¹æ®Šæ•ˆæœ';
    }

    function buyItem(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item || player.money < item.price) {
        showGamePopup("è´­ä¹°å¤±è´¥", "é‡‘é’±ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æ­¤é“å…·ï¼");
        return;
      }
      
      player.money -= item.price;
      addItem(itemId);
      updateStatusBox();
      
      showGamePopup("ğŸ›’ è´­ä¹°æˆåŠŸ", `è·å¾—äº†${item.name}ï¼<br><br>${item.desc}`, `é‡‘é’±-${item.price}`, function() {
        mallItemStore(); // åˆ·æ–°å•†åº—é¡µé¢
      });
    }

    // å…¬å…±å¤„ç†
    function handleAbsence() {
      const day = gameDate.getDay();
      if (day !== 0) {
        hasPerfectAttendance = false;
        absentDays++;
      }
    }

    function endDay(message, changes = {}) {
      nextDay();
      updateStatusBox();
      let statusText = '';
      if (changes.energy || changes.mood || changes.skill || changes.money || changes.maxEnergy) {
        statusText = '<p><b>' + 
          (changes.energy ? `ä½“åŠ› ${changes.energy > 0 ? '+' : ''}${changes.energy}` : '') +
          (changes.mood ? `${changes.energy ? 'ï¼Œ' : ''}å¿ƒæƒ… ${changes.mood > 0 ? '+' : ''}${changes.mood}` : '') +
          (changes.skill ? `${changes.energy || changes.mood ? 'ï¼Œ' : ''}èƒ½åŠ› ${changes.skill > 0 ? '+' : ''}${changes.skill}` : '') +
          (changes.money ? `${changes.energy || changes.mood || changes.skill ? 'ï¼Œ' : ''}é‡‘é’± ${changes.money > 0 ? '+' : ''}${changes.money}` : '') +
          (changes.maxEnergy ? `${changes.energy || changes.mood || changes.skill || changes.money ? 'ï¼Œ' : ''}æœ€å¤§ä½“åŠ› ${changes.maxEnergy > 0 ? '+' : ''}${changes.maxEnergy}` : '') +
          '</b></p>';
      }
      document.getElementById("game-screen").innerHTML = `
        <p>${message}</p>
        ${statusText}
        <button onclick="nextStep()">ç»§ç»­</button>
      `;
    }

    // èŒä¸šç›¸å…³åŠŸèƒ½
    function careerMenu() {
      const gameScreen = document.getElementById("game-screen");
      const daysSinceLastJobChange = Math.floor((gameDate - player.lastJobChange) / (1000 * 60 * 60 * 24));
      const daysSinceLastRaise = Math.floor((gameDate - player.lastSalaryRaise) / (1000 * 60 * 60 * 24));
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æœˆä»½ï¼Œå¦‚æœæ˜¯åˆ™é‡ç½®è·³æ§½å°è¯•æ¬¡æ•°
      const currentMonth = gameDate.getMonth();
      if (currentMonth !== player.lastJobAttemptMonth) {
        player.monthlyJobAttempts = 0;
        player.lastJobAttemptMonth = currentMonth;
      }
      
      // è·³æ§½é™åˆ¶ï¼šé¦–æœˆï¼ˆ9æœˆï¼‰å’Œè·³æ§½åç¬¬ä¸€ä¸ªæœˆä¸èƒ½è·³æ§½
      let jobChangeDisabled = false;
      let jobChangeMessage = "æ‰¾å·¥ä½œè·³æ§½";
      
      // æ£€æŸ¥æ˜¯å¦åœ¨è·³æ§½åçš„ç¬¬ä¸€ä¸ªæœˆå†…
      const lastJobChangeMonth = player.lastJobChange.getMonth();
      const isFirstMonthAfterJobChange = (currentMonth === lastJobChangeMonth) && 
                                        (gameDate.getFullYear() === player.lastJobChange.getFullYear());
      
      if (currentMonth === 8 || isFirstMonthAfterJobChange && currentMonth !== 8) { // é¦–æœˆï¼ˆ9æœˆï¼Œç´¢å¼•ä¸º8ï¼‰å’Œè·³æ§½åé¦–æœˆä¸èƒ½è·³æ§½
        jobChangeDisabled = true;
        jobChangeMessage = "æ‰¾å·¥ä½œè·³æ§½ (åˆšæ¥å°±æƒ³è·³æ§½ï¼Ÿ)";
      } else if (player.monthlyJobAttempts >= 1) {
        jobChangeDisabled = true;
        jobChangeMessage = "æ‰¾å·¥ä½œè·³æ§½ (æœ¬æœˆå·²å°è¯•è¿‡)";
      }
      
      let raiseDisabled = daysSinceLastRaise < 30; // ä¸€ä¸ªæœˆå†…ä¸èƒ½è¦æ±‚æ¶¨è–ª

      gameScreen.innerHTML = `
        <p>ä½ ç›®å‰åœ¨<b>${player.company}</b>å·¥ä½œ</p>
        <p>æœˆè–ªï¼š<b>${player.income}</b>å…ƒ</p>
        <hr>
        <button onclick="tryJobChange()" ${jobChangeDisabled ? 'disabled style="background:#999"' : ''}>
          ${jobChangeMessage}
        </button>
        <button onclick="tryRaiseSalary()" ${raiseDisabled ? 'disabled style="background:#999"' : ''}>
          ç”³è¯·æ¶¨è–ª ${raiseDisabled ? '(è¿˜éœ€ç­‰å¾…'+(30-daysSinceLastRaise)+'å¤©)' : ''}
        </button>
        <hr>
        <button onclick="nextStep()">è¿”å›</button>
      `;
    }

    function tryJobChange() {
      // æ£€æŸ¥å½“å‰æœˆä»½ï¼Œé¦–æœˆä¸èƒ½è·³æ§½
      const currentMonth = gameDate.getMonth();
      
      if (currentMonth === 8) { // é¦–æœˆï¼ˆ9æœˆï¼‰ä¸èƒ½è·³æ§½
        return; // ç›´æ¥è¿”å›ï¼Œä¸åº”è¯¥èƒ½æ‰§è¡Œåˆ°è¿™é‡Œï¼Œä½†ä»¥é˜²ä¸‡ä¸€
      }
      
      // éšæœºé€‰æ‹©3ä¸ªå…¬å¸
      let availableCompanies = companies.filter(c => c.income > player.income);
      let choices = [];
      while (choices.length < 3 && availableCompanies.length > 0) {
        let idx = Math.floor(Math.random() * availableCompanies.length);
        choices.push(availableCompanies[idx]);
        availableCompanies.splice(idx, 1);
      }

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ æŠ•é€’äº†ç®€å†ï¼Œæ”¶åˆ°äº†ä»¥ä¸‹å…¬å¸çš„é¢è¯•é‚€è¯·ï¼š</p>
        ${choices.map(c => `
          <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
            <p><b>${c.name}</b> - ${c.desc}</p>
            <p>æœˆè–ªï¼š${c.income}å…ƒ</p>
            <p>é¢è¯•æˆåŠŸç‡ï¼š${Math.floor(calculateJobSuccessRate(player.skill, c.minSkill))}%</p>
            <button onclick="attemptJobChange('${c.name}', ${c.minSkill}, ${c.income})">å°è¯•å…¥èŒ</button>
          </div>
        `).join('')}
        <hr>
        <button onclick="careerMenu()">è¿”å›</button>
      `;
    }

    function calculateJobSuccessRate(playerSkill, requiredSkill) {
      // è®¡ç®—èƒ½åŠ›æ¯”ç‡
      const skillRatio = playerSkill / requiredSkill;
      let successRate;
      
      if (skillRatio >= 1) {
        // èƒ½åŠ›è¾¾åˆ°æˆ–è¶…è¿‡è¦æ±‚
        // åŸºç¡€60%æˆåŠŸç‡ï¼Œæ¯è¶…è¿‡10%è¦æ±‚å¢åŠ 5%æˆåŠŸç‡ï¼Œæœ€é«˜90%
        successRate = 60 + (skillRatio - 1) * 50;
        successRate = Math.min(90, successRate);
      } else {
        // èƒ½åŠ›ä¸è¶³æ—¶
        // åŸºç¡€æˆåŠŸç‡éšèƒ½åŠ›å·®è·æŒ‡æ•°ä¸‹é™
        successRate = 60 * Math.pow(skillRatio, 2);
      }
      
      return Math.max(0, Math.min(100, successRate));
    }

    function attemptJobChange(companyName, requiredSkill, newIncome) {
      // åœ¨å®é™…å°è¯•é¢è¯•æ—¶æ‰æ¶ˆè€—è·³æ§½æœºä¼š
      player.monthlyJobAttempts += 1;
      
      const successRate = calculateJobSuccessRate(player.skill, requiredSkill);
      const success = Math.random() * 100 < successRate;

      if (success) {
        player.company = companyName;
        player.income = newIncome;
        player.lastJobChange = new Date(gameDate);
        player.mood = Math.min(100, player.mood + 20);
        
        showGamePopup("ğŸ‰ è·³æ§½æˆåŠŸ", `æ­å–œä½ æˆåŠŸå…¥èŒ${companyName}ï¼`, `æœˆè–ª+${newIncome - (newIncome - (newIncome - player.income))}ï¼Œå¿ƒæƒ…+20`, function() {
          updateStatusBox();
          careerMenu();
        });
      } else {
        player.mood = Math.max(0, player.mood - 15);
        showGamePopup("ğŸ˜ é¢è¯•å¤±è´¥", "å¾ˆé—æ†¾ï¼Œé¢è¯•æ²¡æœ‰é€šè¿‡ã€‚<br>ä¸è¦ç°å¿ƒï¼Œç»§ç»­åŠªåŠ›æå‡æŠ€èƒ½å§ï¼", "å¿ƒæƒ…-15", function() {
          updateStatusBox();
          careerMenu();
        });
      }
    }

    function tryRaiseSalary() {
      const raiseAmount = Math.floor(player.income * 0.1); // 10%æ¶¨å¹…
      const requiredSkill = player.skill * 1.1; // éœ€è¦å½“å‰èƒ½åŠ›çš„110%æ‰èƒ½æ¶¨è–ª
      const successRate = Math.min(80, (player.skill / requiredSkill) * 100); // æœ€é«˜80%æˆåŠŸç‡

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ å‡†å¤‡å‘ä¸»ç®¡ç”³è¯·æ¶¨è–ª</p>
        <p>ç›®å‰æœˆè–ªï¼š<b>${player.income}</b>å…ƒ</p>
        <p>æœŸæœ›æ¶¨å¹…ï¼š<b>${raiseAmount}</b>å…ƒ</p>
        <p>æˆåŠŸæ¦‚ç‡ï¼š<b>${Math.floor(successRate)}%</b></p>
        <button onclick="attemptSalaryRaise(${raiseAmount}, ${successRate})">æå‡ºç”³è¯·</button>
        <hr>
        <button onclick="careerMenu()">è¿”å›</button>
      `;
    }

    function attemptSalaryRaise(raiseAmount, successRate) {
      const success = Math.random() * 100 < successRate;

      if (success) {
        player.income += raiseAmount;
        player.lastSalaryRaise = new Date(gameDate);
        player.mood = Math.min(100, player.mood + 10);
        
        showGamePopup("ğŸ’° æ¶¨è–ªæˆåŠŸ", `å¤ªå¥½äº†ï¼æ¶¨è–ªç”³è¯·é€šè¿‡äº†ï¼`, `æœˆè–ª+${raiseAmount}ï¼Œå¿ƒæƒ…+10`, function() {
          updateStatusBox();
          careerMenu();
        });
      } else {
        player.mood = Math.max(0, player.mood - 20);
        showGamePopup("ğŸ˜” æ¶¨è–ªå¤±è´¥", "ä¸»ç®¡è¯´ç°åœ¨å…¬å¸æ•ˆç›Šä¸å¥½ï¼Œæš‚æ—¶æ²¡æœ‰æ¶¨è–ªçš„è®¡åˆ’...", "å¿ƒæƒ…-20", function() {
          updateStatusBox();
          careerMenu();
        });
      }
    }

    // ä½æˆ¿ç›¸å…³åŠŸèƒ½
    function housingMenu() {
      const gameScreen = document.getElementById("game-screen");
      const daysSinceLastHouseChange = Math.floor((gameDate - player.lastHouseChange) / (1000 * 60 * 60 * 24));
      
      let houseChangeDisabled = daysSinceLastHouseChange < 30; // 30å¤©å†…ä¸èƒ½æ¢æˆ¿
      const currentHouse = houses.find(h => h.name === player.house);

      gameScreen.innerHTML = `
        <p>ä½ ç›®å‰ä½åœ¨<b>${player.house}</b></p>
        <p>æœˆç§Ÿï¼š<b>${player.rent}</b>å…ƒ</p>
        <p>ç¡è§‰åŠ æˆï¼šä½“åŠ›+${30 + currentHouse.sleepEnergyBonus}ï¼Œå¿ƒæƒ…+${10 + currentHouse.sleepMoodBonus}</p>
        <p>æ¸¸æˆåŠ æˆï¼šå¿ƒæƒ…+${15 + currentHouse.gameMoodBonus}</p>
        <hr>
        <button onclick="tryHouseChange()" ${houseChangeDisabled ? 'disabled style="background:#999"' : ''}>
          å¯»æ‰¾æ–°æˆ¿æº ${houseChangeDisabled ? '(è¿˜éœ€ç­‰å¾…'+(30-daysSinceLastHouseChange)+'å¤©)' : ''}
        </button>
        <hr>
        <button onclick="nextStep()">è¿”å›</button>
      `;
    }

    function tryHouseChange() {
      // éšæœºé€‰æ‹©3ä¸ªæˆ¿æºï¼ˆæ’é™¤å½“å‰æˆ¿å­ï¼‰
      let availableHouses = houses.filter(h => h.name !== player.house);
      let choices = [];
      while (choices.length < 3 && availableHouses.length > 0) {
        let idx = Math.floor(Math.random() * availableHouses.length);
        choices.push(availableHouses[idx]);
        availableHouses.splice(idx, 1);
      }

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>ä½ æ‰“å¼€ç§Ÿæˆ¿appï¼Œç³»ç»Ÿä¸ºä½ æ¨èäº†ä»¥ä¸‹æˆ¿æºï¼š</p>
        ${choices.map(h => `
          <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
            <p><b>${h.name}</b> - ${h.desc}</p>
            <p>æœˆç§Ÿï¼š${h.rent}å…ƒ</p>
            <p style="font-size:12px; color:#666;">
              ç¡è§‰åŠ æˆï¼šä½“åŠ›+${30 + h.sleepEnergyBonus}ï¼Œå¿ƒæƒ…+${10 + h.sleepMoodBonus} | 
              æ¸¸æˆåŠ æˆï¼šå¿ƒæƒ…+${15 + h.gameMoodBonus}
            </p>
            <button onclick="attemptHouseChange('${h.name}', ${h.rent})" style="margin-top:5px;">æ¬åˆ°è¿™é‡Œ</button>
          </div>
        `).join('')}
        <hr>
        <button onclick="goBackFromHouseSearch()">è¿”å›</button>
      `;
    }

    function goBackFromHouseSearch() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p style="color:#666; font-style:italic;">"å¤§æ•°æ®éƒ½æ¨çš„ä»€ä¹ˆæˆ¿å­â€¦â€¦æ²¡ä¸€ä¸ªåˆé€‚çš„"</p>
        <p>ä½ å…³é—­äº†ç§Ÿæˆ¿appï¼Œå†³å®šæš‚æ—¶ä¸æ¢æˆ¿å­ã€‚</p>
        <button onclick="housingMenu()">è¿”å›</button>
      `;
    }

    function attemptHouseChange(houseName, newRent) {
      // è®¡ç®—å®é™…éœ€è¦çš„èµ„é‡‘ï¼ˆæ–°æˆ¿æŠ¼é‡‘+é¦–æœˆæˆ¿ç§Ÿ-æ—§æˆ¿æŠ¼é‡‘é€€å›ï¼‰
      const oldDeposit = player.rent; // ä¹‹å‰çš„æŠ¼é‡‘ç­‰äºä¹‹å‰çš„æœˆç§Ÿ
      const actualCost = newRent * 2 - oldDeposit; // å®é™…èŠ±è´¹
      
      if (player.money < actualCost) {
        showGamePopup("ğŸ’¸ èµ„é‡‘ä¸è¶³", `æ¢æˆ¿å®é™…éœ€è¦${actualCost}å…ƒ<br>ï¼ˆæ–°æˆ¿æŠ¼é‡‘+é¦–æœˆæˆ¿ç§Ÿ${newRent * 2}å…ƒï¼Œæ‰£é™¤é€€å›æŠ¼é‡‘${oldDeposit}å…ƒï¼‰`);
        return;
      }

      // é€€å›ä¹‹å‰çš„æŠ¼é‡‘
      player.money += oldDeposit; // é€€å›æŠ¼é‡‘
      
      player.house = houseName;
      player.rent = newRent;
      player.money -= newRent * 2; // æ”¯ä»˜æ–°æˆ¿æŠ¼é‡‘å’Œé¦–æœˆæˆ¿ç§Ÿ
      player.lastHouseChange = new Date(gameDate);
      player.mood = Math.min(100, player.mood + 15); // æ¬æ–°å®¶å¿ƒæƒ…å¥½
      
      let message = `æ­å–œä½ æ¬åˆ°äº†${houseName}ï¼<br><br>é€€å›æ—§æˆ¿æŠ¼é‡‘ï¼š${oldDeposit}å…ƒ<br>æ”¯ä»˜æ–°æˆ¿æŠ¼é‡‘å’Œé¦–æœˆæˆ¿ç§Ÿï¼š${newRent * 2}å…ƒ`;
      let effectsText = `é‡‘é’±-${actualCost}ï¼Œå¿ƒæƒ…+15`;
      
      showGamePopup("ğŸ  æ¬å®¶æˆåŠŸ", message, effectsText, function() {
        updateStatusBox();
        housingMenu();
      });
    }
  </script>
</body>
</html>