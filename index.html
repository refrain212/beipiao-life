<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>北漂人生</title>
  <style>
    body {
      font-family: "Microsoft Yahei", sans-serif;
      background: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }
    #status-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 220px;
      text-align: left;
      line-height: 1.6;
      display: none;
    }
    #status-box p {
      margin: 0;
      padding: 2px 0;
      border-bottom: 1px dashed #eee;
    }
    #status-box p:last-child {
      border-bottom: none;
    }
    #items-box {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 220px;
      text-align: left;
      line-height: 1.6;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    #items-box .item-slot {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 2px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;
      text-align: center;
      cursor: pointer;
      vertical-align: top;
      position: relative;
    }
    #items-box .item-slot:hover {
      border-color: #0078d7;
      background: #f0f8ff;
    }
    #items-box .item-slot .item-name {
      font-size: 10px;
      margin-top: 5px;
      line-height: 1.2;
    }
    #items-box .item-slot .item-count {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background: #0078d7;
      color: white;
      border-radius: 8px;
      font-size: 10px;
      padding: 1px 4px;
      min-width: 12px;
    }
    #game-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 400px;
      text-align: center;
    }
    /* 弹窗样式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      width: 350px;
      text-align: center;
      animation: modalShow 0.3s ease-out;
    }
    @keyframes modalShow {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .modal-content h3 {
      margin: 0 0 15px 0;
      color: #0078d7;
    }
    .modal-content .item-info {
      margin: 15px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      text-align: left;
    }
    .modal-buttons {
      margin-top: 20px;
    }
    .modal-buttons button {
      margin: 0 5px;
    }
    /* 游戏内弹窗样式 */
    .game-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .game-popup-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      width: 380px;
      text-align: center;
      animation: gamePopupShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid #0078d7;
    }
    @keyframes gamePopupShow {
      from {
        opacity: 0;
        transform: scale(0.5) translateY(-50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    .game-popup h3 {
      margin: 0 0 15px 0;
      color: #0096d7;
      font-size: 18px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }
    .game-popup .popup-message {
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      text-align: left;
      line-height: 1.6;
      border-left: none;
    }
    .game-popup .popup-effects {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 8px;
      color: #2d5a3d;
      font-size: 14px;
      border: 1px solid #b8e6b8;
    }
    .game-popup-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .game-popup-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      min-width: 80px;
    }
    .popup-btn-primary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
    }
    .popup-btn-primary:hover {
      background: linear-gradient(135deg, #218838 0%, #1c7d73 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(40, 167, 69, 0.4);
    }
    .popup-btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
      box-shadow: 0 3px 8px rgba(108, 117, 125, 0.3);
    }
    .popup-btn-secondary:hover {
      background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(108, 117, 125, 0.4);
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #0078d7;
      color: white;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #005fa3;
    }
    input {
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      margin-top: 10px;
      width: 80%;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input:focus {
      outline: none;
      border-color: #0078d7;
      box-shadow: 0 0 10px rgba(0,120,215,0.3);
      transform: translateY(-2px);
    }
    input::placeholder {
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="status-box"></div>
  <!-- 杂物间按钮 -->
  <div id="items-button" style="position: fixed; bottom: 20px; left: 20px; display: none;">
    <button onclick="openItemsDialog()" style="padding: 10px 15px; background: #0078d7; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      📦 杂物间
    </button>
  </div>
  
  <!-- 道具使用确认弹窗 -->
  <div id="item-confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>使用道具</h3>
      <div id="modal-item-info" class="item-info"></div>
      <div class="modal-buttons">
        <button onclick="confirmUseItem()" style="background: #28a745;">确认使用</button>
        <button onclick="closeItemModal()" style="background: #6c757d;">取消</button>
      </div>
    </div>
  </div>
  
  <!-- 杂物间界面弹窗 -->
  <div id="items-dialog-modal" class="modal-overlay">
    <div class="modal-content" style="width: 450px;">
      <h3>📦 杂物间</h3>
      <div id="items-dialog-grid" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
      <div class="modal-buttons">
        <button onclick="closeItemsDialog()" style="background: #6c757d;">关闭</button>
      </div>
    </div>
  </div>
  
  <!-- 游戏内自定义弹窗 -->
  <div id="game-popup" class="game-popup">
    <div class="game-popup-content">
      <h3 id="popup-title">消息</h3>
      <div id="popup-message" class="popup-message"></div>
      <div id="popup-effects" class="popup-effects" style="display: none;"></div>
      <div class="game-popup-buttons">
        <button id="popup-btn-ok" class="popup-btn-primary" onclick="closeGamePopup()">确定</button>
      </div>
    </div>
  </div>
  
  <div id="game-container">
    <h2 style="color: #0078d7; margin-bottom: 20px; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">🏙️ 北漂人生</h2>
    <div id="start-screen">
      <p style="font-size: 18px; color: #333; margin-bottom: 15px;">请输入你的姓名：</p>
      <input type="text" id="name-input" placeholder="在这里输入你的名字...">
      <br>
      <p style="font-size: 16px; color: #333; margin: 20px 0 10px 0;">选择你的生日：</p>
      <div style="margin: 10px 0;">
        <select id="birth-month" style="padding: 8px; margin-right: 10px; border-radius: 5px; border: 2px solid #e0e0e0;" onchange="updateDayOptions()">
          <option value="0">1月</option>
          <option value="1">2月</option>
          <option value="2">3月</option>
          <option value="3">4月</option>
          <option value="4">5月</option>
          <option value="5">6月</option>
          <option value="6">7月</option>
          <option value="7">8月</option>
          <option value="8">9月</option>
          <option value="9">10月</option>
          <option value="10">11月</option>
          <option value="11">12月</option>
        </select>
        <select id="birth-day" style="padding: 8px; border-radius: 5px; border: 2px solid #e0e0e0;">
          <!-- 动态生成日期选项 -->
        </select>
      </div>
      <button onclick="startGame()" style="margin-top: 20px; padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #0078d7 0%, #005fa3 100%); border-radius: 10px; box-shadow: 0 4px 10px rgba(0,120,215,0.3);">开始游戏</button>
    </div>
    <div id="game-screen" style="display:none;"></div>
  </div>

  <script>
    // 游戏数据
    // 公司数据库
    const companies = [
      { name: "字节跳动", minSkill: 1200, income: 25000, desc: "互联网巨头，工作强度较大" },
      { name: "腾讯", minSkill: 1300, income: 28000, desc: "环境稳定，福利优厚" },
      { name: "阿里巴巴", minSkill: 1400, income: 30000, desc: "996福报" },
      { name: "百度", minSkill: 1100, income: 22000, desc: "老牌大厂" },
      { name: "京东", minSkill: 1000, income: 20000, desc: "电商大厂" },
      { name: "美团", minSkill: 950, income: 18000, desc: "发展迅速" },
      { name: "网易", minSkill: 1050, income: 21000, desc: "氛围轻松" },
      { name: "小米", minSkill: 900, income: 17000, desc: "年轻有活力" },
      { name: "快手", minSkill: 1150, income: 24000, desc: "发展空间大" },
      { name: "滴滴", minSkill: 1000, income: 19000, desc: "平台规模大" },
      { name: "拼多多", minSkill: 1200, income: 26000, desc: "高强度高回报" },
      { name: "猿辅导", minSkill: 850, income: 16000, desc: "教育科技" },
      { name: "BOSS直聘", minSkill: 800, income: 15000, desc: "环境友好" }
    ];

    // 住房数据库
    const houses = [
      // 五环外档次
      { name: "五环外老旧单间", rent: 2500, sleepMoodBonus: -2, sleepEnergyBonus: -3, gameMoodBonus: -1, desc: "年久失修，隔音差" },
      { name: "五环外普通单间", rent: 3000, sleepMoodBonus: 0, sleepEnergyBonus: 0, gameMoodBonus: 0, desc: "便宜但条件一般" },
      { name: "五环外装修单间", rent: 3500, sleepMoodBonus: 1, sleepEnergyBonus: 2, gameMoodBonus: 1, desc: "简单装修，稍微舒适" },
      
      // 四环边档次
      { name: "四环边老式一居", rent: 4000, sleepMoodBonus: 2, sleepEnergyBonus: 3, gameMoodBonus: 1, desc: "独立空间但设施陈旧" },
      { name: "四环边标准一居", rent: 4500, sleepMoodBonus: 3, sleepEnergyBonus: 5, gameMoodBonus: 2, desc: "独立空间，环境较好" },
      { name: "四环边采光一居", rent: 5000, sleepMoodBonus: 5, sleepEnergyBonus: 4, gameMoodBonus: 3, desc: "南北通透，采光极佳" },
      
      // 三环内档次
      { name: "三环内普通一居", rent: 5500, sleepMoodBonus: 4, sleepEnergyBonus: 6, gameMoodBonus: 3, desc: "交通便利，生活方便" },
      { name: "三环内精装一居", rent: 6500, sleepMoodBonus: 6, sleepEnergyBonus: 8, gameMoodBonus: 4, desc: "装修精美，设施齐全" },
      { name: "三环内景观一居", rent: 7000, sleepMoodBonus: 8, sleepEnergyBonus: 7, gameMoodBonus: 5, desc: "高层景观，视野开阔" },
      
      // 二环豪华档次
      { name: "二环标准公寓", rent: 8000, sleepMoodBonus: 7, sleepEnergyBonus: 10, gameMoodBonus: 5, desc: "高端小区，设施完善" },
      { name: "二环豪华公寓", rent: 9500, sleepMoodBonus: 10, sleepEnergyBonus: 12, gameMoodBonus: 7, desc: "奢华装修，管家服务" },
      { name: "二环顶级公寓", rent: 11000, sleepMoodBonus: 12, sleepEnergyBonus: 15, gameMoodBonus: 8, desc: "顶级配置，私人管家" },
      
      // 市中心顶级档次
      { name: "市中心商务公寓", rent: 12000, sleepMoodBonus: 10, sleepEnergyBonus: 18, gameMoodBonus: 6, desc: "商务配置，效率优先" },
      { name: "市中心精装豪宅", rent: 15000, sleepMoodBonus: 15, sleepEnergyBonus: 20, gameMoodBonus: 10, desc: "地段优越，装修精美" },
      { name: "市中心顶级豪宅", rent: 20000, sleepMoodBonus: 20, sleepEnergyBonus: 25, gameMoodBonus: 15, desc: "奢华至极，身份象征" }
    ];

    // 道具数据库
    const items = [
      { id: 1, name: "游戏卡带", price: 300, desc: "最新的3A大作，画面精美", energyCost: -5, moodGain: 25 },
      { id: 2, name: "咖啡豆", price: 80, desc: "精品咖啡豆，提神醒脑", energyGain: 20, moodGain: 10 },
      { id: 3, name: "按摩器", price: 500, desc: "缓解疲劳的神器", energyGain: 30, moodGain: 15 },
      { id: 4, name: "编程书籍", price: 150, desc: "提升编程技能的好书", skillGain: 10, moodGain: 5 },
      { id: 5, name: "肥宅快乐水", price: 50, desc: "总之就是很快乐", moodGain: 20 },
      { id: 6, name: "蛋白粉", price: 120, desc: "健身人士必备", moodGain: 2, special: "gym_bonus" }
    ];

    // 日期处理函数
    function getDaysInMonth(month, year = 2005) {
      // 月份是0-11，这里转换为1-12来计算
      return new Date(year, month + 1, 0).getDate();
    }

    function updateDayOptions() {
      const monthSelect = document.getElementById("birth-month");
      const daySelect = document.getElementById("birth-day");
      const selectedMonth = parseInt(monthSelect.value);
      const currentDay = parseInt(daySelect.value) || 1;
      
      // 清除现有选项
      daySelect.innerHTML = '';
      
      // 获取该月的天数
      const daysInMonth = getDaysInMonth(selectedMonth);
      
      // 生成日期选项
      for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + '日';
        if (day === currentDay && day <= daysInMonth) {
          option.selected = true;
        } else if (day === 1 && currentDay > daysInMonth) {
          option.selected = true;
        }
        daySelect.appendChild(option);
      }
    }

    // 计算游戏开始日期（确保主角开局时22岁）
    function calculateGameStartDate(birthMonth, birthDay) {
      const birthYear = 2005;
      const currentYear = 2027; // 22岁时应该是2027年
      
      // 游戏开始日期就是22岁生日当天（入职第一天）
      const gameStart = new Date(currentYear, birthMonth, birthDay);
      
      return gameStart;
    }

    let player = {
      name: "",
      age: 22,
      birthMonth: 0, // 生日月份 (0-11)
      birthDay: 1,   // 生日日期 (1-31)
      money: 10000,
      income: 8000,
      rent: 0, // 初始没有房租
      energy: 100,
      maxEnergy: 100,
      mood: 100,
      skill: 500,  // 工作能力
      company: "小型互联网公司",
      house: "", // 初始没有房子
      inventory: {}, // 道具库存
      gymBonus: false, // 蛋白粉健身加成状态
      lastJobChange: new Date(2025, 8, 1), // 上次跳槽时间
      lastSalaryRaise: new Date(2025, 8, 1), // 上次涨薪时间
      lastHouseChange: new Date(2025, 8, 1), // 上次换房时间
      monthlyJobAttempts: 0, // 本月跳槽尝试次数
      lastJobAttemptMonth: 8 // 上次跳槽尝试的月份
    };

    let gameDate = new Date(2025, 8, 1);
    let hasPerfectAttendance = true;
    let absentDays = 0;
    let changes = {}; // 全局变化量记录

    // 工具函数：应用属性变化
    function applyChange(key, value) {
      if (key === 'mood') {
        player.mood = Math.max(0, Math.min(100, player.mood + value));
      } else if (key === 'energy') {
        player.energy = Math.min(player.maxEnergy, player.energy + value);
      } else if (key === 'maxEnergy') {
        player.maxEnergy = Math.min(120, player.maxEnergy + value);
      } else {
        player[key] += value;
      }
      changes[key] = (changes[key] || 0) + value;
    }

    // 重置变化量记录
    function resetChanges() {
      changes = {};
    }

    // 道具相关函数
    function addItem(itemId, quantity = 1) {
      if (!player.inventory[itemId]) {
        player.inventory[itemId] = 0;
      }
      player.inventory[itemId] += quantity;
    }

    function useItem(itemId) {
      if (!player.inventory[itemId] || player.inventory[itemId] <= 0) {
        return false;
      }
      
      const item = items.find(i => i.id === itemId);
      if (!item) return false;
      
      resetChanges();
      
      if (item.energyGain) applyChange('energy', item.energyGain);
      if (item.energyCost) applyChange('energy', item.energyCost);
      if (item.moodGain) applyChange('mood', item.moodGain);
      if (item.skillGain) applyChange('skill', item.skillGain);
      if (item.maxEnergyGain) applyChange('maxEnergy', item.maxEnergyGain);
      
      // 处理蛋白粉特殊效果
      if (item.special === "gym_bonus") {
        player.gymBonus = true;
      }
      
      player.inventory[itemId]--;
      updateStatusBox();
      
      return true;
    }

    function getDateString() {
      const weekDays = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
      return `${gameDate.getFullYear()}.${gameDate.getMonth() + 1}.${gameDate.getDate()} ${weekDays[gameDate.getDay()]}`;
    }

    function updateStatusBox() {
      const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
      const birthday = `${monthNames[player.birthMonth]}${player.birthDay}日`;
      
      const statusBox = document.getElementById("status-box");
      statusBox.innerHTML = `
        <p>日期：${getDateString()}</p>
        <p>姓名：${player.name} | 年龄：${player.age}岁</p>
        <p>生日：${birthday}</p>
        <p>公司：${player.company}</p>
        <p>月薪：${player.income}元</p>
        <p>住房：${player.house || "暂无"}</p>
        <p>房租：${player.rent}元</p>
        <p>体力：${player.energy}/${player.maxEnergy}</p>
        <p>心情：${player.mood}</p>
        <p>能力：${player.skill}</p>
        <p>存款：${player.money}元</p>
        ${player.house ? '<button onclick="careerMenu()" style="width:100%; margin-top:5px;">关于工作...</button>' : ''}
        ${player.house ? '<button onclick="housingMenu()" style="width:100%; margin-top:5px;">关于住房...</button>' : ''}
      `;
      updateItemsButton();
    }

    // 更新杂物间按钮显示状态
    function updateItemsButton() {
      const itemsButton = document.getElementById("items-button");
      if (!itemsButton) return;
      
      // 检查是否有道具
      let hasItems = false;
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          hasItems = true;
          break;
        }
      }
      
      // 只有在游戏开始且有道具时才显示按钮
      if (player.name) {
        itemsButton.style.display = "block";
      } else {
        itemsButton.style.display = "none";
      }
    }

    // 打开杂物间对话框
    function openItemsDialog() {
      const modal = document.getElementById("items-dialog-modal");
      const itemsGrid = document.getElementById("items-dialog-grid");
      
      // 获取玩家拥有的道具
      let ownedItems = [];
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          const item = items.find(i => i.id == itemId);
          if (item) {
            ownedItems.push({...item, quantity: player.inventory[itemId]});
          }
        }
      }
      
      if (ownedItems.length === 0) {
        itemsGrid.innerHTML = '<p style="color:#999; text-align:center; margin:20px 0;">杂物间空空如也</p>';
      } else {
        itemsGrid.innerHTML = ownedItems.map(item => `
          <div style="margin: 10px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='#f0f8ff'; this.style.borderColor='#0078d7';" 
               onmouseout="this.style.background='white'; this.style.borderColor='#eee';"
               onclick="showItemConfirm(${item.id})">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <p style="margin: 0; font-weight: bold; color: #0078d7;">${item.name}</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${item.desc}</p>
                <p style="margin: 5px 0 0 0; font-size: 11px; color: #999;">
                  效果：${getItemEffectText(item)}
                </p>
              </div>
              <div style="background: #0078d7; color: white; border-radius: 12px; padding: 4px 8px; font-size: 12px; min-width: 20px; text-align: center;">
                ${item.quantity}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      modal.style.display = "flex";
    }

    // 关闭杂物间对话框
    function closeItemsDialog() {
      const modal = document.getElementById("items-dialog-modal");
      modal.style.display = "none";
    }

    let currentItemToUse = null;

    // 显示道具使用确认弹窗
    function showItemConfirm(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item || !player.inventory[itemId] || player.inventory[itemId] <= 0) {
        return;
      }
      
      currentItemToUse = itemId;
      const modal = document.getElementById("item-confirm-modal");
      const itemInfo = document.getElementById("modal-item-info");
      
      itemInfo.innerHTML = `
        <div style="text-align: center; margin-bottom: 10px;">
          <h4 style="margin: 0; color: #0078d7;">${item.name}</h4>
          <p style="margin: 5px 0; color: #666; font-size: 14px;">${item.desc}</p>
        </div>
        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
          <p style="margin: 0; font-size: 13px;"><strong>使用效果：</strong>${getItemEffectText(item)}</p>
          <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">拥有数量：${player.inventory[itemId]}</p>
        </div>
      `;
      
      // 先关闭杂物间对话框
      closeItemsDialog();
      // 显示确认弹窗
      modal.style.display = "flex";
    }

    // 确认使用道具
    function confirmUseItem() {
      if (currentItemToUse === null) return;
      
      const item = items.find(i => i.id === currentItemToUse);
      if (!item) return;
      
      if (useItem(currentItemToUse)) {
        let message = `使用了${item.name}`;
        
        // 特殊的使用效果描述
        if (item.name === "游戏卡带") {
          message += "，沉迷在精彩的游戏中。";
        } else if (item.name === "咖啡豆") {
          message += "，冲了一杯香浓的咖啡。";
        } else if (item.name === "按摩器") {
          message += "，按摩缓解了疲劳。";
        } else if (item.name === "编程书籍") {
          message += "，学到了新的技术知识。";
        } else if (item.name === "肥宅快乐水") {
          message += "，喝了一口，感觉无比快乐。";
        } else if (item.name === "蛋白粉") {
          message += "，下次健身效果会更好！";
        }
        
        // 显示效果
        let effects = [];
        if (item.energyGain) effects.push(`体力+${item.energyGain}`);
        if (item.energyCost) effects.push(`体力${item.energyCost}`);
        if (item.moodGain) effects.push(`心情+${item.moodGain}`);
        if (item.skillGain) effects.push(`能力+${item.skillGain}`);
        if (item.special === "gym_bonus") effects.push(`获得健身加成`);
        
        let effectsText = effects.length > 0 ? effects.join('，') : null;
        
        showGamePopup("道具使用成功", message, effectsText, function() {
          updateStatusBox();
        });
      } else {
        showGamePopup("使用失败", "道具使用失败，请稍后再试！");
      }
      
      closeItemModal();
      currentItemToUse = null;
    }

    // 关闭道具确认弹窗
    function closeItemModal() {
      const modal = document.getElementById("item-confirm-modal");
      modal.style.display = "none";
      currentItemToUse = null;
    }

    // 游戏内弹窗系统
    function showGamePopup(title, message, effects = null, onConfirm = null) {
      const popup = document.getElementById("game-popup");
      const titleEl = document.getElementById("popup-title");
      const messageEl = document.getElementById("popup-message");
      const effectsEl = document.getElementById("popup-effects");
      const okBtn = document.getElementById("popup-btn-ok");
      
      titleEl.textContent = title;
      messageEl.innerHTML = message;
      
      if (effects) {
        effectsEl.innerHTML = `<strong>效果变化：</strong>${effects}`;
        effectsEl.style.display = "block";
      } else {
        effectsEl.style.display = "none";
      }
      
      // 设置确认按钮的回调
      okBtn.onclick = function() {
        closeGamePopup();
        if (onConfirm) onConfirm();
      };
      
      popup.style.display = "flex";
    }

    function closeGamePopup() {
      const popup = document.getElementById("game-popup");
      popup.style.display = "none";
    }

    // 键盘事件处理
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeItemsDialog();
        closeItemModal();
        closeGamePopup();
      }
    });

    // 点击弹窗外部关闭弹窗
    document.addEventListener('click', function(event) {
      const itemsModal = document.getElementById("items-dialog-modal");
      const itemConfirmModal = document.getElementById("item-confirm-modal");
      const gamePopup = document.getElementById("game-popup");
      
      if (event.target === itemsModal) {
        closeItemsDialog();
      }
      if (event.target === itemConfirmModal) {
        closeItemModal();
      }
      if (event.target === gamePopup) {
        closeGamePopup();
      }
    });

    function startGame() {
      const nameInput = document.getElementById("name-input").value;
      const birthMonth = parseInt(document.getElementById("birth-month").value);
      const birthDay = parseInt(document.getElementById("birth-day").value);
      
      if (!nameInput.trim()) {
        showGamePopup("提示", "请输入你的姓名才能开始游戏！");
        return;
      }
      
      player.name = nameInput;
      player.birthMonth = birthMonth;
      player.birthDay = birthDay;
      
      // 根据生日计算游戏开始日期
      gameDate = calculateGameStartDate(birthMonth, birthDay);
      
      // 更新所有基于日期的属性
      player.lastJobChange = new Date(gameDate);
      player.lastSalaryRaise = new Date(gameDate);
      player.lastHouseChange = new Date(gameDate);
      
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-screen").style.display = "block";
      document.getElementById("status-box").style.display = "block";
      
      // 进入梦境选择
      showDreamChoice();
    }

    function resetGame() {
      // 重置游戏数据
      player = {
        name: "",
        age: 22,
        birthMonth: 0,
        birthDay: 1,
        money: 10000,
        income: 8000,
        rent: 0,
        energy: 100,
        maxEnergy: 100,
        mood: 100,
        skill: 500,
        company: "小型互联网公司",
        house: "",
        inventory: {}, // 重置库存
        gymBonus: false, // 重置蛋白粉状态
        lastJobChange: new Date(2027, 0, 1), // 临时日期，实际会在startGame中重新计算
        lastSalaryRaise: new Date(2027, 0, 1),
        lastHouseChange: new Date(2027, 0, 1),
        monthlyJobAttempts: 0, // 本月跳槽尝试次数
        lastJobAttemptMonth: 0 // 上次跳槽尝试的月份
      };
      gameDate = new Date(2027, 0, 1); // 临时日期，实际会在startGame中重新计算
      hasPerfectAttendance = true;
      absentDays = 0;

      // 重置界面
      document.getElementById("name-input").value = "";
      document.getElementById("birth-month").value = "0";
      updateDayOptions(); // 重置日期选项
      document.getElementById("game-screen").style.display = "none";
      document.getElementById("start-screen").style.display = "block";
      document.getElementById("status-box").style.display = "none";
      document.getElementById("items-button").style.display = "none";
      
      // 关闭所有弹窗
      document.getElementById("items-dialog-modal").style.display = "none";
      document.getElementById("item-confirm-modal").style.display = "none";
      document.getElementById("game-popup").style.display = "none";
    }

    // 页面加载时初始化日期选项
    window.addEventListener('load', function() {
      updateDayOptions();
    });

    // 梦境选择系统
    function showDreamChoice() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
          <p style="font-style: italic; color: #b8b8d4; margin-bottom: 15px;">你做了一个梦...</p>
          <hr style="border-color: #444;">
          <p>在朦胧的梦境中，你看到一个面目模糊的神秘人影。</p>
          <p>那人用低沉的声音问你：</p>
          <p style="color: #e6e6fa; font-weight: bold;">"你想过怎样的人生？"</p>
          <hr style="border-color: #444;">
          <p>你的回答是：</p>
          <button onclick="chooseDream('normal')" style="margin: 5px; padding: 10px 15px; background: #4a5568; color: white; border: none; border-radius: 5px; cursor: pointer;">普普通通就好</button>
          <button onclick="chooseDream('random')" style="margin: 5px; padding: 10px 15px; background: #2d3748; color: white; border: none; border-radius: 5px; cursor: pointer;">随便吧</button>
        </div>
      `;
    }

    function chooseDream(choice) {
      const gameScreen = document.getElementById("game-screen");
      
      if (choice === 'normal') {
        // 普通开局 - 保持默认设置
        gameScreen.innerHTML = `
          <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
            <p>你回答<span style="color: #90cdf4;">"普普通通就好"</span>后，那人点了点头，突然消失不见了。</p>
            <hr style="border-color: #444;">
            <p style="font-style: italic; color: #b8b8d4;">梦境渐渐散去...</p>
            <button onclick="finishDream()" style="margin-top: 15px; padding: 10px 20px; background: #4a5568; color: white; border: none; border-radius: 5px; cursor: pointer;">醒来</button>
          </div>
        `;
      } else if (choice === 'random') {
        // 随机开局 - 随机化属性
        const randomIncome = Math.floor(Math.random() * (10000 - 6000 + 1)) + 6000; // 6000-10000
        const randomMoney = Math.floor(Math.random() * (20000 - 3500 + 1)) + 3500;   // 3500-20000

        player.income = randomIncome;
        player.money = randomMoney;
        
        gameScreen.innerHTML = `
          <div style="background: linear-gradient(135deg, #2c1810, #1a1a2e); color: #f0f0f0; padding: 20px; border-radius: 10px; margin: 10px 0;">
            <p>你回答<span style="color: #fbb6ce;">"随便吧"</span>后，那人点了点头，突然消失不见了。</p>
            <p style="color: #a78bfa;">在他消失的瞬间，你感到一股奇异的力量涌入体内...</p>
            <hr style="border-color: #444;">
            <p style="font-style: italic; color: #b8b8d4;">梦境渐渐散去...</p>
            <p style="color: #68d391; font-size: 12px;">你感觉到命运发生了微妙的变化</p>
            <button onclick="finishDream()" style="margin-top: 15px; padding: 10px 20px; background: #553c9a; color: white; border: none; border-radius: 5px; cursor: pointer;">醒来</button>
          </div>
        `;
      }
    }

    function finishDream() {
      updateStatusBox();
      showIntro();
    }

    function showIntro() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你叫 <b>${player.name}</b>，今年 22 岁，本科毕业后来到北京，开始了北漂生活。</p>
        <p>你在一家互联网小厂工作，月收入 <b>${player.income}</b> 元。</p>
        <p>赖于父母的资助和你自己攒的资金，你当前的存款是 <b>${player.money}</b> 元。</p>
        <p>今天是你入职公司的第一天。好巧，今天也是你的生日。</p>
        <p>可惜没有时间庆祝，摆在你眼前的还有许多问题。</p>
        <p>等稳定下来一定要给自己好好过一个生日，你暗暗想着。</p>
        <p>没时间多想了，你得赶紧去公司报道。</p>
        <button onclick="goOutBeforeWork()">出门</button>
      `;
    }

    function goOutBeforeWork() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>出门之前，你扫视了出租屋，回想起了一个月前租房的情景</p>
        <button onclick="chooseInitialHouse()">回想</button>
      `;
    }

    function chooseInitialHouse() {
      const gameScreen = document.getElementById("game-screen");
      const outerRingHouses = houses.filter(h => h.name.includes("五环外"));
      
      gameScreen.innerHTML = `
        <p style="color:#999; font-style:italic; text-align:center; margin-bottom:15px;">——— 一个月前的回忆 ———</p>
        <p>你在租房app上搜索着适合的房源...</p>
        <p style="color:#666; font-style:italic;">"现在没钱，公司也挺偏的，就这个地段好了......"</p>
        <hr>
        <p>你找到了以下几个五环外的房源：</p>
        ${outerRingHouses.map(h => `
          <div style="margin: 10px 0; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; text-align: left; background: rgba(240, 240, 240, 0.5); filter: blur(0.5px); opacity: 0.8;">
            <p><b>${h.name}</b> - ${h.desc}</p>
            <p>月租：${h.rent}元</p>
            <p style="font-size:12px; color:#666;">
              睡觉加成：体力+${30 + h.sleepEnergyBonus}，心情+${10 + h.sleepMoodBonus} | 
              游戏加成：心情+${15 + h.gameMoodBonus}
            </p>
            <button onclick="selectInitialHouse('${h.name}', ${h.rent})" style="opacity: 1; filter: none;">选择这里</button>
          </div>
        `).join('')}
      `;
    }

    function selectInitialHouse(houseName, houseRent) {
      player.house = houseName;
      player.rent = houseRent;
      player.money -= houseRent * 2; // 支付押金和首月房租
      
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        
        <p>最终挑挑拣拣，你选择了<b>${houseName}</b>，月租 <b>${houseRent}</b> 元。</p>
        <p>支付了押金和首月房租共 <b>${houseRent * 2}</b> 元。</p>
        <p>当前存款：<b>${player.money}</b> 元。</p>
        <p>房子环境一般，离公司也远，只能说是权宜之计。</p>
        <p style="color:#999; font-style:italic; text-align:center;">——————— 回忆结束 ———————</p>
        <p>但现在不是想这些的时候了。</p>
        <p>得赶紧去公司报道了，迟到可不好。</p>
        <p>以后有钱了再租个好一点的房子吧，至于什么时候能买得起自己的房子……你摇了摇头，不再去想。</p>
        <button onclick="goToWork()">出门上班</button>
      `;
      updateStatusBox();
    }

    // 第一天强制上班函数
    function goToWork() {
      const gameScreen = document.getElementById("game-screen");
      
      // 第一天必须上班，显示特殊剧情
      resetChanges();
      applyChange('energy', -5);
      applyChange('mood', -5);
      applyChange('skill', 5);
      
      gameScreen.innerHTML = `
        <p><b>第一天上班</b></p>
        <hr>
        <p>你怀着忐忑不安的心情来到公司楼下，抬头望着这栋并不算高的写字楼。</p>
        <p>"就是这里了..."你深吸一口气，走进了大厅。</p>
        <p>前台小姐姐很热情地为你办理了入职手续，给了你工牌和临时电脑密码。</p>
        <p>你被分配到了开发部，坐在了一个靠窗的位置。虽然是小公司，但同事们看起来都很友善。</p>
        <p>组长给你介绍了工作内容和项目情况，虽然技术栈有些陌生，但你觉得自己能够胜任。</p>
        <p>"新人嘛，慢慢来，不要有压力。"组长拍了拍你的肩膀说道。</p>
        <p>第一天主要是熟悉环境和代码，虽然有些紧张，但总体来说还算顺利。</p>
        <hr>
        <p style="color:#666; font-size:14px;"><b>体力 -5，心情 -5，能力 +5</b></p>
        <button onclick="firstDayEnd()">下班回家</button>
      `;
      
      updateStatusBox();
    }

    // 第一天结束函数
    function firstDayEnd() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你拖着疲惫的身体回到了租住的房间。</p>
        <p>虽然第一天有些紧张，但总算是顺利度过了。</p>
        <p>"北漂生活，正式开始了..."你看着窗外的夜景，心中五味杂陈。</p>
        <hr>
        <p>从明天开始，你需要自己规划每一天的生活。</p>
        <button onclick="finishIntro()">开始新的一天</button>
      `;
      nextDay();
      updateStatusBox(); // 更新状态显示新的日期
    }

    function finishIntro() {
      nextStep();
    }

    function nextDay() {
      gameDate.setDate(gameDate.getDate() + 1);
      checkBirthday();
      if (gameDate.getDate() === 1) {
        settleSalary();
      }
    }

    function checkBirthday() {
      const today = gameDate;
      if (today.getMonth() === player.birthMonth && today.getDate() === player.birthDay) {
        player.age++;
        handleBirthdayEvent();
      }
    }

    function handleBirthdayEvent() {
      if (player.age === 23) {
        // 23岁生日特殊事件
        player.money += 2000;
        player.mood = Math.min(100, player.mood + 30);
        
        showGamePopup(
          "🎂 生日快乐！", 
          `今天是你的${player.age}岁生日！<br><br>📱 微信消息不断弹出...<br><br>"儿子生日快乐！妈妈给你发了2000块钱红包，记得收一下~"<br><br>"生日快乐啊，小子都23了，什么时候带个女朋友回家？隔壁老王家的孩子都订婚了..."<br><br>看着父母的关心和"催婚"，你心情复杂但也很温暖。`, 
          "年龄+1，金钱+2000，心情+30"
        );
      } else {
        // 普通生日
        player.mood = Math.min(100, player.mood + 20);
        let birthdayMessages = [
          `今天是你的${player.age}岁生日！虽然独自在北京，但还是要庆祝一下。`,
          `${player.age}岁生日快乐！时间过得真快，又长大了一岁。`,
          `生日快乐！${player.age}岁的你在北京继续奋斗着。`
        ];
        
        showGamePopup(
          "🎂 生日快乐！", 
          birthdayMessages[Math.floor(Math.random() * birthdayMessages.length)], 
          `年龄+1，心情+20`
        );
      }
    }

    function settleSalary() {
      const workDaysInMonth = 26;
      let bonus = hasPerfectAttendance ? Math.floor(player.income * 0.25) : 0;
      let dailySalary = Math.floor(player.income / workDaysInMonth);
      let actualWorkDays = workDaysInMonth - absentDays;
      actualWorkDays = Math.max(0, actualWorkDays);
      let actualSalary = dailySalary * actualWorkDays;

      player.money += actualSalary + bonus - player.rent;
      updateStatusBox();

      let message = `本月工作${actualWorkDays}天<br>实发工资：${actualSalary}元<br>全勤奖：${bonus}元<br>扣除房租：${player.rent}元`;
      let effectsText = `金钱+${actualSalary + bonus - player.rent}`;
      
      showGamePopup("💰 月底结算", message, effectsText);
      hasPerfectAttendance = true;
      absentDays = 0;
    }

    function nextStep() {
      const gameScreen = document.getElementById("game-screen");
      const day = gameDate.getDay();

      if (player.energy < 0) {
        gameScreen.innerHTML = `
          <h3>游戏结束</h3>
          <p>时间：<b>${getDateString()}</b></p>
          <p>主角存款：<b>${player.money}</b> 元</p>
          <p style="color:#C1437A;font-weight:bold;">身体是革命的本钱</p>
          <button onclick="resetGame()" style="margin-top: 20px;">重新开始</button>
        `;
        return;
      }

      let optionsHtml = '';
      if (day === 0) {
        optionsHtml = '<button onclick="restMenu()">在家休息</button>';
      } else {
        optionsHtml = '<button onclick="chooseWork()">去公司上班</button>' +
                      '<button onclick="restMenu()">在家休息</button>';
      }

      gameScreen.innerHTML = `
        <p>今天是 <b>${getDateString()}</b>。</p>
        <p>今天你想：</p>
        ${optionsHtml}
      `;
    }

    // 上班逻辑
    function chooseWork() {
      const day = gameDate.getDay();
      let message = "";
      let statusText = "";

      if (day === 0) {
        message = "今天是周日，公司休息。";
      } else {
        resetChanges();
        applyChange('energy', -5);
        applyChange('mood', -5);
        
        if (player.mood === 0) {
          // 心情降到0时，摸鱼模式
          message = "你完全提不起精神，整天都在划水摸鱼。";
        } else if (player.mood < 20) {
          // 心情很低时，有可能被主管责骂
          if (Math.random() < 0.5) {
            message = "你心不在焉，上班时被主管骂了一顿，心情更加糟糕。";
            applyChange('mood', -10);
            applyChange('skill', 1);
          } else {
            message = "你勉强完成了工作，效率很低。";
            applyChange('skill', 2);
          }
        } else {
          // 正常工作
          message = "你努力工作了一天，积累了一些经验。";
          applyChange('skill', 5);
          if (Math.random() < 0.1) {  // 10%概率获得额外成长
            message += "今天遇到了一个技术难题，但被你解决了！心情不错！";
            applyChange('skill', 3);
            applyChange('mood', 5); // 解决难题时增加心情
          }
        }

        statusText = `<p><b>体力 -5，心情 ${changes.mood > 0 ? '+' + changes.mood : changes.mood}${changes.skill > 0 ? '，能力 +' + changes.skill : ''}</b></p>`;
      }

      nextDay();
      updateStatusBox();
      document.getElementById("game-screen").innerHTML = `
        <p>${message}</p>
        ${statusText}
        <button onclick="nextStep()">继续</button>
      `;
    }

    // 二级休息菜单
    function restMenu() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你决定在家休息，可以选择：</p>
        <button onclick="restSleep()">睡一觉</button>
        <button onclick="restGame()">在家打游戏</button>
        <button onclick="readForum()">看论坛</button>
        <button onclick="goOutMenu()">出去走走</button>
      `;
    }

    function readForum() {
      resetChanges();
      applyChange('skill', 3);
      applyChange('mood', 10);
      handleAbsence();

      let events = [
        "你在论坛上看到了一些有趣的技术讨论，学到了新知识。",
        "你发现了一个很好的技术教程，认真学习了一下午。",
        "你在论坛上和其他程序员交流，获得了一些新的见解。"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      endDay(message, changes);
    }

    function restSleep() {
      resetChanges();
      const currentHouse = houses.find(h => h.name === player.house);
      const moodBonus = currentHouse ? currentHouse.sleepMoodBonus : 0;
      const energyBonus = currentHouse ? currentHouse.sleepEnergyBonus : 0;
      
      applyChange('energy', 30 + energyBonus);
      applyChange('mood', 10 + moodBonus);
      handleAbsence();
      
      let message = "你美美地睡了一觉，精神恢复了不少。";
      if (currentHouse) {
        if (moodBonus > 0 || energyBonus > 0) {
          message += `舒适的居住环境让你睡得更香甜！`;
        } else if (moodBonus < 0 || energyBonus < 0) {
          message += `糟糕的环境影响了你的睡眠质量...`;
        }
      }
      
      endDay(message, changes);
    }

    function restGame() {
      resetChanges();
      const currentHouse = houses.find(h => h.name === player.house);
      const moodBonus = currentHouse ? currentHouse.gameMoodBonus : 0;
      
      applyChange('energy', 10);
      applyChange('mood', 15 + moodBonus);
      handleAbsence();
      
      let message = "你在家打了一天游戏，虽然有点宅，但心情好多了。";
      if (currentHouse) {
        if (moodBonus > 0) {
          message += `舒适的环境让游戏体验更棒！`;
        } else if (moodBonus < 0) {
          message += `糟糕的环境让你有些烦躁...`;
        }
      }
      
      endDay(message, changes);
    }

    function goOutMenu() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你决定出去走走，去哪里呢？</p>
        <button onclick="goPark()">公园</button>
        <button onclick="goNetCafe()">网吧</button>
        <button onclick="goMall()">商场</button>
        <button onclick="goGym()">健身房</button>
        <button onclick="goBackHome()">还是回家吧</button>
      `;
    }

    function goGym() {
      resetChanges();
      applyChange('money', -100);
      applyChange('energy', -20);
      
      // 基础体力上限增加
      let maxEnergyGain = 1;
      // 如果有蛋白粉加成，额外+1
      if (player.gymBonus) {
        maxEnergyGain += 1;
        player.gymBonus = false; // 使用后清除加成
      }
      applyChange('maxEnergy', maxEnergyGain);
      applyChange('mood', 15);
      handleAbsence();

      let events = [
        "你进行了一次充实的健身训练，虽然很累但感觉很棒。",
        "健身让你感觉充满活力，对生活更有信心了。",
        "你遇到了几个志同道合的健身伙伴，互相加油打气。"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (maxEnergyGain > 1) {
        message += "蛋白粉发挥了作用，训练效果格外显著！";
      }
      
      endDay(message, changes);
    }

    function goBackHome() {
      // 消耗体力并显示弹窗说明
      resetChanges();
      applyChange('energy', -5); // 出门一趟稍微消耗点体力
      updateStatusBox(); // 更新状态显示
      
      showGamePopup("🏠 回到家中", "突然想起来煤气还没关。", "体力-5", function() {
        restMenu(); // 回到休息菜单
      });
    }

    function useItemMenu() {
      const gameScreen = document.getElementById("game-screen");
      
      // 获取玩家拥有的道具
      let ownedItems = [];
      for (let itemId in player.inventory) {
        if (player.inventory[itemId] > 0) {
          const item = items.find(i => i.id == itemId);
          if (item) {
            ownedItems.push({...item, quantity: player.inventory[itemId]});
          }
        }
      }
      
      if (ownedItems.length === 0) {
        gameScreen.innerHTML = `
          <p>你的背包里没有任何道具。</p>
          <p>去商场买一些有用的道具吧！</p>
          <button onclick="restMenu()">返回</button>
        `;
        return;
      }
      
      gameScreen.innerHTML = `
        <p>你的道具背包：</p>
        <div style="max-height: 300px; overflow-y: auto;">
          ${ownedItems.map(item => `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
              <p><b>${item.name}</b> x${item.quantity}</p>
              <p>${item.desc}</p>
              <p style="font-size:12px; color:#666;">
                效果：${getItemEffectText(item)}
              </p>
              <button onclick="useItemAndShow(${item.id})">使用</button>
            </div>
          `).join('')}
        </div>
        <hr>
        <button onclick="restMenu()">返回</button>
      `;
    }

    function useItemAndShow(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item) return;
      
      if (useItem(itemId)) {
        let message = `你使用了${item.name}。${item.desc}`;
        
        // 特殊的使用效果描述
        if (item.name === "游戏卡带") {
          message = "你沉迷在游戏的精彩剧情中，虽然有些累但心情很好。";
        } else if (item.name === "咖啡豆") {
          message = "你冲了一杯香浓的咖啡，瞬间精神了不少。";
        } else if (item.name === "按摩器") {
          message = "按摩器缓解了你的疲劳，整个人都放松了。";
        } else if (item.name === "编程书籍") {
          message = "你认真阅读了编程书籍，学到了一些新的技术知识。";
        } else if (item.name === "健康零食") {
          message = "美味的零食让你心情愉悦。";
        } else if (item.name === "蛋白粉") {
          message = "好喝的蛋白粉，喝完不会头顶尖尖。";
        }
        
        handleAbsence();
        endDay(message, changes);
      } else {
        alert("使用失败！");
      }
    }

    function goPark() {
      resetChanges();
      applyChange('energy', 5);
      
      let events = [
        "你在公园里散步，心情放松了许多。",
        "你遇到一个老同学，聊了很久。",
        "突然下雨了，你被淋湿，心情降低。"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("淋湿")) {
        applyChange('mood', -10);
      } else {
        applyChange('mood', 25);
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function goNetCafe() {
      resetChanges();
      applyChange('money', -100);
      applyChange('mood', 40);
      
      let events = [
        "你在网吧玩得很开心，结识了几个新朋友。",
        "你通宵打游戏，第二天精神状态很差。"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("通宵")) {
        applyChange('energy', -30);  // 通宵减少30点体力
      } else {
        applyChange('energy', -10);  // 正常减少10点体力
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function goMall() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你来到了商场，这里有很多店铺...</p>
        <button onclick="mallShopping()">购买日用品</button>
        <button onclick="mallItemStore()">道具商店</button>
        <button onclick="mallRandomEvent()">随便逛逛</button>
        <button onclick="goOutMenu()">返回</button>
      `;
    }

    function mallShopping() {
      resetChanges();
      applyChange('money', -200);
      applyChange('energy', -15);
      
      let events = [
        "你在商场买到了打折好货，很开心。",
        "你冲动消费，回家后有点后悔。"
      ];
      let message = events[Math.floor(Math.random() * events.length)];
      
      if (message.includes("后悔")) {
        applyChange('mood', -10);
      } else {
        applyChange('mood', 30);
      }
      
      handleAbsence();
      endDay(message, changes);
    }

    function mallRandomEvent() {
      resetChanges();
      applyChange('energy', -10);
      applyChange('mood', 15);
      handleAbsence();
      
      let message = "你在商场里闲逛，看了看各种商品，心情还不错。";
      endDay(message, changes);
    }

    function mallItemStore() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>欢迎来到道具商店！你可以购买各种有用的物品：</p>
        <div style="max-height: 300px; overflow-y: auto;">
          ${items.map(item => `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
              <p><b>${item.name}</b> - ${item.desc}</p>
              <p>价格：${item.price}元</p>
              <p style="font-size:12px; color:#666;">
                效果：${getItemEffectText(item)}
              </p>
              <button onclick="buyItem(${item.id})" ${player.money < item.price ? 'disabled style="background:#999"' : ''}>
                ${player.money < item.price ? '金钱不足' : '购买'}
              </button>
            </div>
          `).join('')}
        </div>
        <hr>
        <button onclick="goMall()">返回商场</button>
      `;
    }

    function getItemEffectText(item) {
      let effects = [];
      if (item.energyGain) effects.push(`体力+${item.energyGain}`);
      if (item.energyCost) effects.push(`体力${item.energyCost}`);
      if (item.moodGain) effects.push(`心情+${item.moodGain}`);
      if (item.skillGain) effects.push(`能力+${item.skillGain}`);
      if (item.maxEnergyGain) effects.push(`最大体力+${item.maxEnergyGain}`);
      if (item.special === "gym_bonus") effects.push(`下次健身时体力上限额外+1`);
      return effects.join('，') || '特殊效果';
    }

    function buyItem(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item || player.money < item.price) {
        showGamePopup("购买失败", "金钱不足，无法购买此道具！");
        return;
      }
      
      player.money -= item.price;
      addItem(itemId);
      updateStatusBox();
      
      showGamePopup("🛒 购买成功", `获得了${item.name}！<br><br>${item.desc}`, `金钱-${item.price}`, function() {
        mallItemStore(); // 刷新商店页面
      });
    }

    // 公共处理
    function handleAbsence() {
      const day = gameDate.getDay();
      if (day !== 0) {
        hasPerfectAttendance = false;
        absentDays++;
      }
    }

    function endDay(message, changes = {}) {
      nextDay();
      updateStatusBox();
      let statusText = '';
      if (changes.energy || changes.mood || changes.skill || changes.money || changes.maxEnergy) {
        statusText = '<p><b>' + 
          (changes.energy ? `体力 ${changes.energy > 0 ? '+' : ''}${changes.energy}` : '') +
          (changes.mood ? `${changes.energy ? '，' : ''}心情 ${changes.mood > 0 ? '+' : ''}${changes.mood}` : '') +
          (changes.skill ? `${changes.energy || changes.mood ? '，' : ''}能力 ${changes.skill > 0 ? '+' : ''}${changes.skill}` : '') +
          (changes.money ? `${changes.energy || changes.mood || changes.skill ? '，' : ''}金钱 ${changes.money > 0 ? '+' : ''}${changes.money}` : '') +
          (changes.maxEnergy ? `${changes.energy || changes.mood || changes.skill || changes.money ? '，' : ''}最大体力 ${changes.maxEnergy > 0 ? '+' : ''}${changes.maxEnergy}` : '') +
          '</b></p>';
      }
      document.getElementById("game-screen").innerHTML = `
        <p>${message}</p>
        ${statusText}
        <button onclick="nextStep()">继续</button>
      `;
    }

    // 职业相关功能
    function careerMenu() {
      const gameScreen = document.getElementById("game-screen");
      const daysSinceLastJobChange = Math.floor((gameDate - player.lastJobChange) / (1000 * 60 * 60 * 24));
      const daysSinceLastRaise = Math.floor((gameDate - player.lastSalaryRaise) / (1000 * 60 * 60 * 24));
      
      // 检查是否是新月份，如果是则重置跳槽尝试次数
      const currentMonth = gameDate.getMonth();
      if (currentMonth !== player.lastJobAttemptMonth) {
        player.monthlyJobAttempts = 0;
        player.lastJobAttemptMonth = currentMonth;
      }
      
      // 跳槽限制：首月（9月）和跳槽后第一个月不能跳槽
      let jobChangeDisabled = false;
      let jobChangeMessage = "找工作跳槽";
      
      // 检查是否在跳槽后的第一个月内
      const lastJobChangeMonth = player.lastJobChange.getMonth();
      const isFirstMonthAfterJobChange = (currentMonth === lastJobChangeMonth) && 
                                        (gameDate.getFullYear() === player.lastJobChange.getFullYear());
      
      if (currentMonth === 8 || isFirstMonthAfterJobChange && currentMonth !== 8) { // 首月（9月，索引为8）和跳槽后首月不能跳槽
        jobChangeDisabled = true;
        jobChangeMessage = "找工作跳槽 (刚来就想跳槽？)";
      } else if (player.monthlyJobAttempts >= 1) {
        jobChangeDisabled = true;
        jobChangeMessage = "找工作跳槽 (本月已尝试过)";
      }
      
      let raiseDisabled = daysSinceLastRaise < 30; // 一个月内不能要求涨薪

      gameScreen.innerHTML = `
        <p>你目前在<b>${player.company}</b>工作</p>
        <p>月薪：<b>${player.income}</b>元</p>
        <hr>
        <button onclick="tryJobChange()" ${jobChangeDisabled ? 'disabled style="background:#999"' : ''}>
          ${jobChangeMessage}
        </button>
        <button onclick="tryRaiseSalary()" ${raiseDisabled ? 'disabled style="background:#999"' : ''}>
          申请涨薪 ${raiseDisabled ? '(还需等待'+(30-daysSinceLastRaise)+'天)' : ''}
        </button>
        <hr>
        <button onclick="nextStep()">返回</button>
      `;
    }

    function tryJobChange() {
      // 检查当前月份，首月不能跳槽
      const currentMonth = gameDate.getMonth();
      
      if (currentMonth === 8) { // 首月（9月）不能跳槽
        return; // 直接返回，不应该能执行到这里，但以防万一
      }
      
      // 随机选择3个公司
      let availableCompanies = companies.filter(c => c.income > player.income);
      let choices = [];
      while (choices.length < 3 && availableCompanies.length > 0) {
        let idx = Math.floor(Math.random() * availableCompanies.length);
        choices.push(availableCompanies[idx]);
        availableCompanies.splice(idx, 1);
      }

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你投递了简历，收到了以下公司的面试邀请：</p>
        ${choices.map(c => `
          <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
            <p><b>${c.name}</b> - ${c.desc}</p>
            <p>月薪：${c.income}元</p>
            <p>面试成功率：${Math.floor(calculateJobSuccessRate(player.skill, c.minSkill))}%</p>
            <button onclick="attemptJobChange('${c.name}', ${c.minSkill}, ${c.income})">尝试入职</button>
          </div>
        `).join('')}
        <hr>
        <button onclick="careerMenu()">返回</button>
      `;
    }

    function calculateJobSuccessRate(playerSkill, requiredSkill) {
      // 计算能力比率
      const skillRatio = playerSkill / requiredSkill;
      let successRate;
      
      if (skillRatio >= 1) {
        // 能力达到或超过要求
        // 基础60%成功率，每超过10%要求增加5%成功率，最高90%
        successRate = 60 + (skillRatio - 1) * 50;
        successRate = Math.min(90, successRate);
      } else {
        // 能力不足时
        // 基础成功率随能力差距指数下降
        successRate = 60 * Math.pow(skillRatio, 2);
      }
      
      return Math.max(0, Math.min(100, successRate));
    }

    function attemptJobChange(companyName, requiredSkill, newIncome) {
      // 在实际尝试面试时才消耗跳槽机会
      player.monthlyJobAttempts += 1;
      
      const successRate = calculateJobSuccessRate(player.skill, requiredSkill);
      const success = Math.random() * 100 < successRate;

      if (success) {
        player.company = companyName;
        player.income = newIncome;
        player.lastJobChange = new Date(gameDate);
        player.mood = Math.min(100, player.mood + 20);
        
        showGamePopup("🎉 跳槽成功", `恭喜你成功入职${companyName}！`, `月薪+${newIncome - (newIncome - (newIncome - player.income))}，心情+20`, function() {
          updateStatusBox();
          careerMenu();
        });
      } else {
        player.mood = Math.max(0, player.mood - 15);
        showGamePopup("😞 面试失败", "很遗憾，面试没有通过。<br>不要灰心，继续努力提升技能吧！", "心情-15", function() {
          updateStatusBox();
          careerMenu();
        });
      }
    }

    function tryRaiseSalary() {
      const raiseAmount = Math.floor(player.income * 0.1); // 10%涨幅
      const requiredSkill = player.skill * 1.1; // 需要当前能力的110%才能涨薪
      const successRate = Math.min(80, (player.skill / requiredSkill) * 100); // 最高80%成功率

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你准备向主管申请涨薪</p>
        <p>目前月薪：<b>${player.income}</b>元</p>
        <p>期望涨幅：<b>${raiseAmount}</b>元</p>
        <p>成功概率：<b>${Math.floor(successRate)}%</b></p>
        <button onclick="attemptSalaryRaise(${raiseAmount}, ${successRate})">提出申请</button>
        <hr>
        <button onclick="careerMenu()">返回</button>
      `;
    }

    function attemptSalaryRaise(raiseAmount, successRate) {
      const success = Math.random() * 100 < successRate;

      if (success) {
        player.income += raiseAmount;
        player.lastSalaryRaise = new Date(gameDate);
        player.mood = Math.min(100, player.mood + 10);
        
        showGamePopup("💰 涨薪成功", `太好了！涨薪申请通过了！`, `月薪+${raiseAmount}，心情+10`, function() {
          updateStatusBox();
          careerMenu();
        });
      } else {
        player.mood = Math.max(0, player.mood - 20);
        showGamePopup("😔 涨薪失败", "主管说现在公司效益不好，暂时没有涨薪的计划...", "心情-20", function() {
          updateStatusBox();
          careerMenu();
        });
      }
    }

    // 住房相关功能
    function housingMenu() {
      const gameScreen = document.getElementById("game-screen");
      const daysSinceLastHouseChange = Math.floor((gameDate - player.lastHouseChange) / (1000 * 60 * 60 * 24));
      
      let houseChangeDisabled = daysSinceLastHouseChange < 30; // 30天内不能换房
      const currentHouse = houses.find(h => h.name === player.house);

      gameScreen.innerHTML = `
        <p>你目前住在<b>${player.house}</b></p>
        <p>月租：<b>${player.rent}</b>元</p>
        <p>睡觉加成：体力+${30 + currentHouse.sleepEnergyBonus}，心情+${10 + currentHouse.sleepMoodBonus}</p>
        <p>游戏加成：心情+${15 + currentHouse.gameMoodBonus}</p>
        <hr>
        <button onclick="tryHouseChange()" ${houseChangeDisabled ? 'disabled style="background:#999"' : ''}>
          寻找新房源 ${houseChangeDisabled ? '(还需等待'+(30-daysSinceLastHouseChange)+'天)' : ''}
        </button>
        <hr>
        <button onclick="nextStep()">返回</button>
      `;
    }

    function tryHouseChange() {
      // 随机选择3个房源（排除当前房子）
      let availableHouses = houses.filter(h => h.name !== player.house);
      let choices = [];
      while (choices.length < 3 && availableHouses.length > 0) {
        let idx = Math.floor(Math.random() * availableHouses.length);
        choices.push(availableHouses[idx]);
        availableHouses.splice(idx, 1);
      }

      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p>你打开租房app，系统为你推荐了以下房源：</p>
        ${choices.map(h => `
          <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; text-align: left;">
            <p><b>${h.name}</b> - ${h.desc}</p>
            <p>月租：${h.rent}元</p>
            <p style="font-size:12px; color:#666;">
              睡觉加成：体力+${30 + h.sleepEnergyBonus}，心情+${10 + h.sleepMoodBonus} | 
              游戏加成：心情+${15 + h.gameMoodBonus}
            </p>
            <button onclick="attemptHouseChange('${h.name}', ${h.rent})" style="margin-top:5px;">搬到这里</button>
          </div>
        `).join('')}
        <hr>
        <button onclick="goBackFromHouseSearch()">返回</button>
      `;
    }

    function goBackFromHouseSearch() {
      const gameScreen = document.getElementById("game-screen");
      gameScreen.innerHTML = `
        <p style="color:#666; font-style:italic;">"大数据都推的什么房子……没一个合适的"</p>
        <p>你关闭了租房app，决定暂时不换房子。</p>
        <button onclick="housingMenu()">返回</button>
      `;
    }

    function attemptHouseChange(houseName, newRent) {
      // 计算实际需要的资金（新房押金+首月房租-旧房押金退回）
      const oldDeposit = player.rent; // 之前的押金等于之前的月租
      const actualCost = newRent * 2 - oldDeposit; // 实际花费
      
      if (player.money < actualCost) {
        showGamePopup("💸 资金不足", `换房实际需要${actualCost}元<br>（新房押金+首月房租${newRent * 2}元，扣除退回押金${oldDeposit}元）`);
        return;
      }

      // 退回之前的押金
      player.money += oldDeposit; // 退回押金
      
      player.house = houseName;
      player.rent = newRent;
      player.money -= newRent * 2; // 支付新房押金和首月房租
      player.lastHouseChange = new Date(gameDate);
      player.mood = Math.min(100, player.mood + 15); // 搬新家心情好
      
      let message = `恭喜你搬到了${houseName}！<br><br>退回旧房押金：${oldDeposit}元<br>支付新房押金和首月房租：${newRent * 2}元`;
      let effectsText = `金钱-${actualCost}，心情+15`;
      
      showGamePopup("🏠 搬家成功", message, effectsText, function() {
        updateStatusBox();
        housingMenu();
      });
    }
  </script>
</body>
</html>