// ==UserScript==
// @name         DeepSeek ÁøªËØëÂä©Êâã - ÁÆÄÂåñÁâà
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description  ÁÆÄÂçïÊòìÁî®ÁöÑÁΩëÈ°µÁøªËØëÂ∑•ÂÖ∑ÔºåÊîØÊåÅÂÖ®Â±ÄÁøªËØëÂíåÂàíËØçÁøªËØë
// @author       ÊÇ®ÁöÑÂêçÂ≠ó
// @match        *://*/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      api.deepseek.com
// @license      MIT
// ==/UserScript==

(function() {
    'use strict';

    // ========================================
    // üîß ÈÖçÁΩÆÂå∫Âüü - Âú®ËøôÈáåÂ°´ÂÖ•ÊÇ®ÁöÑAPI Key
    // ========================================
    const CONFIG = {
        // üëá ËØ∑Âú®‰∏ãÈù¢ÁöÑÂçïÂºïÂè∑ÂÜÖÂ°´ÂÖ•ÊÇ®ÁöÑ DeepSeek API Key
        API_KEY: 'sk-fdc6b68f14d14138999874e046f031ec',  // Ê†ºÂºè: 'sk-xxxxxxxxxxxxxxxxxxxxxxxxxx'
        
        // ÂÖ∂‰ªñÈÖçÁΩÆ
        TARGET_LANGUAGE: 'zh',  // ÁõÆÊ†áËØ≠Ë®Ä: zh=‰∏≠Êñá, en=Ëã±Êñá, ja=Êó•Êñá, ko=Èü©Êñá
        AUTO_TRANSLATE: false,  // ÊòØÂê¶Ëá™Âä®ÁøªËØëÈÄâ‰∏≠ÁöÑÊñáÊú¨
        BUTTON_POSITION: { x: 50, y: 50 }  // ÊÇ¨ÊµÆÁêÉÂàùÂßã‰ΩçÁΩÆ
    };

    // ========================================
    // Ê†∏ÂøÉÁøªËØëÂäüËÉΩ
    // ========================================
    class SimpleTranslator {
        constructor() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂÆû‰æãÂ≠òÂú®
            if (window.deepseekTranslatorInstance) {
                console.log('‚è≠Ô∏è ÁøªËØëÂô®ÂÆû‰æãÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÈáçÂ§çÂàõÂª∫');
                return window.deepseekTranslatorInstance;
            }
            
            this.isGlobalMode = false;
            this.isSelectionMode = true;
            this.selectedText = '';
            
            // Ê†áËÆ∞ÂÆû‰æãÂ∑≤ÂàõÂª∫
            window.deepseekTranslatorInstance = this;
            
            this.init();
        }

        init() {
            console.log('üöÄ SimpleTranslator ÂºÄÂßãÂàùÂßãÂåñ...');
            
            // ÊåâÈ°∫Â∫èÂàùÂßãÂåñÂêÑ‰∏™ÁªÑ‰ª∂
            try {
                this.createStyles();
                console.log('‚úÖ Ê†∑ÂºèÂ∑≤ÂàõÂª∫');
                
                // Âª∂ËøüÂàõÂª∫ÊÇ¨ÊµÆÁêÉÔºåÁ°Æ‰øùÊ†∑ÂºèÂ∑≤Â∫îÁî®
                setTimeout(() => {
                    this.createFloatingBall();
                }, 100);
                
                this.createTranslatePanel();
                console.log('‚úÖ ÁøªËØëÈù¢ÊùøÂ∑≤ÂàõÂª∫');
                
                this.bindEvents();
                console.log('‚úÖ ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
                
                console.log('üéâ SimpleTranslator ÂàùÂßãÂåñÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå SimpleTranslator ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }

        // ÂàõÂª∫Ê†∑Âºè
        createStyles() {
            console.log('üé® ÂºÄÂßãÂàõÂª∫Ê†∑Âºè...');
            const style = document.createElement('style');
            style.id = 'deepseek-translator-styles';
            style.textContent = `
                /* ÊÇ¨ÊµÆÁêÉÊ†∑Âºè */
                .ds-float-ball {
                    position: fixed !important;
                    width: 50px !important;
                    height: 50px !important;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    border: none !important;
                    border-radius: 50% !important;
                    color: white !important;
                    font-size: 18px !important;
                    font-weight: bold !important;
                    cursor: move !important;
                    z-index: 999999 !important;
                    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4) !important;
                    transition: all 0.3s ease !important;
                    user-select: none !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                }

                .ds-float-ball:hover {
                    transform: scale(1.1) !important;
                    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6) !important;
                }

                .ds-float-ball.dragging {
                    transform: scale(1.05) !important;
                    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.8) !important;
                }

                /* ÁøªËØëÈù¢ÊùøÊ†∑Âºè */
                .ds-translate-panel {
                    position: fixed !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 600px !important;
                    max-width: 90vw !important;
                    background: white !important;
                    border-radius: 12px !important;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
                    z-index: 1000000 !important;
                    display: none !important;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                    overflow: hidden !important;
                }

                .ds-panel-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    color: white !important;
                    padding: 15px 20px !important;
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                }

                .ds-panel-title {
                    font-size: 16px !important;
                    font-weight: 600 !important;
                    margin: 0 !important;
                }

                .ds-panel-controls {
                    display: flex !important;
                    gap: 10px !important;
                }

                .ds-control-btn {
                    background: rgba(255,255,255,0.2) !important;
                    border: none !important;
                    color: white !important;
                    padding: 5px 12px !important;
                    border-radius: 6px !important;
                    cursor: pointer !important;
                    font-size: 12px !important;
                    transition: all 0.2s !important;
                }

                .ds-control-btn:hover {
                    background: rgba(255,255,255,0.3) !important;
                }

                .ds-control-btn.active {
                    background: rgba(255,255,255,0.4) !important;
                }

                .ds-panel-body {
                    padding: 20px !important;
                }

                .ds-textarea {
                    width: 100% !important;
                    min-height: 120px !important;
                    border: 2px solid #e1e1e1 !important;
                    border-radius: 8px !important;
                    padding: 12px !important;
                    font-size: 14px !important;
                    resize: vertical !important;
                    margin-bottom: 15px !important;
                    box-sizing: border-box !important;
                    font-family: inherit !important;
                }

                .ds-textarea:focus {
                    outline: none !important;
                    border-color: #667eea !important;
                }

                .ds-result-area {
                    background: #f8f9fa !important;
                    border: 1px solid #e9ecef !important;
                    border-radius: 8px !important;
                    padding: 15px !important;
                    min-height: 100px !important;
                    margin-bottom: 15px !important;
                    font-size: 14px !important;
                    line-height: 1.6 !important;
                    white-space: pre-wrap !important;
                }

                .ds-button-group {
                    display: flex !important;
                    gap: 10px !important;
                    justify-content: flex-end !important;
                }

                .ds-btn {
                    padding: 10px 20px !important;
                    border: none !important;
                    border-radius: 6px !important;
                    cursor: pointer !important;
                    font-size: 14px !important;
                    transition: all 0.2s !important;
                }

                .ds-btn-primary {
                    background: #667eea !important;
                    color: white !important;
                }

                .ds-btn-primary:hover {
                    background: #5a6fd8 !important;
                }

                .ds-btn-secondary {
                    background: #6c757d !important;
                    color: white !important;
                }

                .ds-btn-secondary:hover {
                    background: #5a6268 !important;
                }

                .ds-overlay {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: rgba(0,0,0,0.5) !important;
                    z-index: 999999 !important;
                    display: none !important;
                }

                /* ÁøªËØë‰∏≠Áä∂ÊÄÅ */
                .ds-translating {
                    color: #667eea !important;
                }

                /* ÈÄâ‰∏≠ÊñáÊú¨È´ò‰∫Æ */
                .ds-selected-text {
                    background: rgba(102, 126, 234, 0.2) !important;
                    transition: background 0.2s !important;
                }
            `;
            document.head.appendChild(style);
            console.log('‚úÖ Ê†∑ÂºèÂ∑≤Ê∑ªÂä†Âà∞È°µÈù¢Â§¥ÈÉ®');
        }

        // ÂàõÂª∫ÊÇ¨ÊµÆÁêÉ
        createFloatingBall() {
            console.log('üéØ ÂºÄÂßãÂàõÂª∫ÊÇ¨ÊµÆÁêÉ...');
            
            // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÊÇ¨ÊµÆÁêÉ
            if (document.querySelector('.ds-float-ball')) {
                console.log('‚è≠Ô∏è ÊÇ¨ÊµÆÁêÉÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫');
                return;
            }
            
            this.floatingBall = document.createElement('button');
            this.floatingBall.className = 'ds-float-ball';
            this.floatingBall.textContent = 'ËØë';
            this.floatingBall.title = 'DeepSeek ÁøªËØëÂä©Êâã\nÁÇπÂáªÊâìÂºÄÁøªËØëÈù¢Êùø\nÊãñÂä®ÂèØÁßªÂä®‰ΩçÁΩÆ';
            
            // ËÆæÁΩÆÂÜÖËÅîÊ†∑ÂºèÔºåÁ°Æ‰øùÊòæÁ§∫
            const styles = {
                position: 'fixed',
                top: CONFIG.BUTTON_POSITION.y + 'px',
                left: CONFIG.BUTTON_POSITION.x + 'px',
                width: '50px',
                height: '50px',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                border: 'none',
                borderRadius: '50%',
                color: 'white',
                fontSize: '18px',
                fontWeight: 'bold',
                cursor: 'pointer',
                zIndex: '2147483647',  // ÊúÄÈ´òÂ±ÇÁ∫ß
                boxShadow: '0 4px 20px rgba(102, 126, 234, 0.4)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                userSelect: 'none',
                transition: 'all 0.3s ease'
            };
            
            // Â∫îÁî®ÊâÄÊúâÊ†∑Âºè
            Object.assign(this.floatingBall.style, styles);
            
            console.log('üìç ÊÇ¨ÊµÆÁêÉÂÖÉÁ¥†Â∑≤ÂàõÂª∫ÔºåÊ≠£Âú®Ê∑ªÂä†Âà∞È°µÈù¢...');
            document.body.appendChild(this.floatingBall);
            console.log('‚úÖ ÊÇ¨ÊµÆÁêÉÂ∑≤Ê∑ªÂä†Âà∞È°µÈù¢');
            
            // È™åËØÅÂÖÉÁ¥†ÊòØÂê¶Âú®È°µÈù¢‰∏≠
            const added = document.querySelector('.ds-float-ball');
            if (added) {
                console.log('‚úÖ ÊÇ¨ÊµÆÁêÉÂú®È°µÈù¢‰∏≠Á°ÆËÆ§Â≠òÂú®');
            } else {
                console.error('‚ùå ÊÇ¨ÊµÆÁêÉÊú™ËÉΩÊ∑ªÂä†Âà∞È°µÈù¢');
            }
            
            // ÁÆÄÂçïÁöÑÁÇπÂáª‰∫ã‰ª∂
            this.floatingBall.onclick = (e) => {
                console.log('üñ±Ô∏è ÊÇ¨ÊµÆÁêÉË¢´ÁÇπÂáª (onclick)');
                e.preventDefault();
                e.stopPropagation();
                alert('ÁøªËØëÈù¢ÊùøÂäüËÉΩÊµãËØï - ÁÇπÂáªÊàêÂäüÔºÅ');
                this.showPanel();
            };
            
            // Èº†Ê†áÊÇ¨ÂÅúÊïàÊûú
            this.floatingBall.onmouseenter = () => {
                this.floatingBall.style.transform = 'scale(1.1)';
                this.floatingBall.style.boxShadow = '0 6px 25px rgba(102, 126, 234, 0.6)';
            };
            
            this.floatingBall.onmouseleave = () => {
                this.floatingBall.style.transform = 'scale(1)';
                this.floatingBall.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4)';
            };
            
            // ÁªëÂÆöÊãñÊãΩÂäüËÉΩ
            this.makeDraggable(this.floatingBall);
        }

        // ÂàõÂª∫ÁøªËØëÈù¢Êùø
        createTranslatePanel() {
            console.log('üé® ÂºÄÂßãÂàõÂª∫ÁøªËØëÈù¢Êùø...');
            
            // ÈÅÆÁΩ©Â±Ç
            this.overlay = document.createElement('div');
            this.overlay.className = 'ds-overlay';
            this.overlay.addEventListener('click', () => this.hidePanel());
            console.log('‚úÖ ÈÅÆÁΩ©Â±ÇÂ∑≤ÂàõÂª∫');
            
            // ‰∏ªÈù¢Êùø
            this.panel = document.createElement('div');
            this.panel.className = 'ds-translate-panel';
            
            // ÂàõÂª∫Èù¢ÊùøÂ§¥ÈÉ®
            const header = document.createElement('div');
            header.className = 'ds-panel-header';
            
            const title = document.createElement('h3');
            title.className = 'ds-panel-title';
            title.textContent = 'üåç DeepSeek ÁøªËØëÂä©Êâã';
            
            const controls = document.createElement('div');
            controls.className = 'ds-panel-controls';
            
            // ÂàõÂª∫ÊéßÂà∂ÊåâÈíÆ
            const globalBtn = document.createElement('button');
            globalBtn.className = 'ds-control-btn';
            globalBtn.id = 'ds-global-mode';
            globalBtn.title = 'ÂÖ®Â±ÄÁøªËØëÊ®°Âºè';
            globalBtn.textContent = 'ÂÖ®Â±Ä';
            
            const selectionBtn = document.createElement('button');
            selectionBtn.className = 'ds-control-btn active';
            selectionBtn.id = 'ds-selection-mode';
            selectionBtn.title = 'ÂàíËØçÁøªËØëÊ®°Âºè';
            selectionBtn.textContent = 'ÂàíËØç';
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'ds-control-btn';
            closeBtn.id = 'ds-close-panel';
            closeBtn.title = 'ÂÖ≥Èó≠Èù¢Êùø';
            closeBtn.textContent = '‚úï';
            
            controls.appendChild(globalBtn);
            controls.appendChild(selectionBtn);
            controls.appendChild(closeBtn);
            
            header.appendChild(title);
            header.appendChild(controls);
            
            // ÂàõÂª∫Èù¢Êùø‰∏ª‰Ωì
            const body = document.createElement('div');
            body.className = 'ds-panel-body';
            
            // ËæìÂÖ•Ê°Ü
            const textarea = document.createElement('textarea');
            textarea.className = 'ds-textarea';
            textarea.id = 'ds-input-text';
            textarea.placeholder = 'Âú®Ê≠§ËæìÂÖ•Ë¶ÅÁøªËØëÁöÑÊñáÊú¨ÔºåÊàñËÄÖÂú®È°µÈù¢‰∏äÈÄâÊã©ÊñáÊú¨...';
            
            // ÁªìÊûúÂå∫Âüü
            const resultArea = document.createElement('div');
            resultArea.className = 'ds-result-area';
            resultArea.id = 'ds-result-area';
            resultArea.textContent = 'ÁøªËØëÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫';
            
            // ÊåâÈíÆÁªÑ
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'ds-button-group';
            
            const clearBtn = document.createElement('button');
            clearBtn.className = 'ds-btn ds-btn-secondary';
            clearBtn.id = 'ds-clear-btn';
            clearBtn.textContent = 'Ê∏ÖÁ©∫';
            
            const translateBtn = document.createElement('button');
            translateBtn.className = 'ds-btn ds-btn-primary';
            translateBtn.id = 'ds-translate-btn';
            translateBtn.textContent = 'ÁøªËØë';
            
            buttonGroup.appendChild(clearBtn);
            buttonGroup.appendChild(translateBtn);
            
            body.appendChild(textarea);
            body.appendChild(resultArea);
            body.appendChild(buttonGroup);
            
            this.panel.appendChild(header);
            this.panel.appendChild(body);
            
            document.body.appendChild(this.overlay);
            document.body.appendChild(this.panel);
            
            console.log('‚úÖ ÁøªËØëÈù¢ÊùøÂ∑≤ÂàõÂª∫Âπ∂Ê∑ªÂä†Âà∞DOM');
        }

        // ÁªëÂÆö‰∫ã‰ª∂
        bindEvents() {
            // Èù¢ÊùøÊéßÂà∂ÊåâÈíÆ
            document.getElementById('ds-global-mode').addEventListener('click', () => {
                this.toggleMode('global');
            });
            
            document.getElementById('ds-selection-mode').addEventListener('click', () => {
                this.toggleMode('selection');
            });
            
            document.getElementById('ds-close-panel').addEventListener('click', () => {
                this.hidePanel();
            });
            
            // ÂäüËÉΩÊåâÈíÆ
            document.getElementById('ds-translate-btn').addEventListener('click', () => {
                this.translateText();
            });
            
            document.getElementById('ds-clear-btn').addEventListener('click', () => {
                this.clearText();
            });
            
            // ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂
            document.addEventListener('mouseup', (e) => {
                if (this.isSelectionMode) {
                    setTimeout(() => this.handleTextSelection(e), 100);
                }
            });
            
            // ÈîÆÁõòÂø´Êç∑ÈîÆ
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                    e.preventDefault();
                    this.showPanel();
                }
            });
        }

        // Ê®°ÂºèÂàáÊç¢
        toggleMode(mode) {
            const globalBtn = document.getElementById('ds-global-mode');
            const selectionBtn = document.getElementById('ds-selection-mode');
            
            if (mode === 'global') {
                this.isGlobalMode = true;
                this.isSelectionMode = false;
                globalBtn.classList.add('active');
                selectionBtn.classList.remove('active');
            } else {
                this.isGlobalMode = false;
                this.isSelectionMode = true;
                globalBtn.classList.remove('active');
                selectionBtn.classList.add('active');
            }
        }

        // Â§ÑÁêÜÊñáÊú¨ÈÄâÊã©
        handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText && selectedText.length > 0) {
                this.selectedText = selectedText;
                document.getElementById('ds-input-text').value = selectedText;
                
                if (CONFIG.AUTO_TRANSLATE) {
                    this.translateText();
                } else {
                    // ÊòæÁ§∫ÊèêÁ§∫ÊàñËÄÖËá™Âä®ÊâìÂºÄÈù¢Êùø
                    if (!this.isPanelVisible()) {
                        this.showPanel();
                    }
                }
            }
        }

        // ÁøªËØëÊñáÊú¨
        async translateText() {
            const inputText = document.getElementById('ds-input-text').value.trim();
            const resultArea = document.getElementById('ds-result-area');
            const translateBtn = document.getElementById('ds-translate-btn');
            
            if (!inputText) {
                resultArea.textContent = 'ËØ∑ËæìÂÖ•Ë¶ÅÁøªËØëÁöÑÊñáÊú¨';
                return;
            }
            
            if (!CONFIG.API_KEY) {
                resultArea.textContent = '‚ùå ËØ∑ÂÖàÈÖçÁΩÆ DeepSeek API Key\nÂú®ËÑöÊú¨Êñá‰ª∂ÂºÄÂ§¥ÁöÑ CONFIG.API_KEY Â§ÑÂ°´ÂÖ•ÊÇ®ÁöÑ API Key';
                return;
            }
            
            // ÊòæÁ§∫ÁøªËØë‰∏≠Áä∂ÊÄÅ
            translateBtn.disabled = true;
            translateBtn.textContent = 'ÁøªËØë‰∏≠...';
            resultArea.textContent = 'üîÑ Ê≠£Âú®ÁøªËØëÔºåËØ∑Á®çÂÄô...';
            
            try {
                const translation = await this.callDeepSeekAPI(inputText);
                resultArea.textContent = translation;
            } catch (error) {
                console.error('ÁøªËØëÂ§±Ë¥•:', error);
                resultArea.textContent = `‚ùå ÁøªËØëÂ§±Ë¥•: ${error.message}`;
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = 'ÁøªËØë';
            }
        }

        // Ë∞ÉÁî® DeepSeek API
        callDeepSeekAPI(text) {
            return new Promise((resolve, reject) => {
                const targetLangName = this.getLanguageName(CONFIG.TARGET_LANGUAGE);
                const prompt = `ËØ∑Â∞Ü‰ª•‰∏ãÊñáÊú¨ÁøªËØë‰∏∫${targetLangName}ÔºåÂè™ËøîÂõûÁøªËØëÁªìÊûúÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïËß£ÈáäÔºö\n\n${text}`;
                
                GM_xmlhttpRequest({
                    method: 'POST',
                    url: 'https://api.deepseek.com/v1/chat/completions',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    data: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.1
                    }),
                    onload: function(response) {
                        try {
                            const data = JSON.parse(response.responseText);
                            if (data.choices && data.choices[0] && data.choices[0].message) {
                                resolve(data.choices[0].message.content.trim());
                            } else {
                                reject(new Error('API ÂìçÂ∫îÊ†ºÂºèÈîôËØØ'));
                            }
                        } catch (error) {
                            reject(new Error('Ëß£ÊûêÂìçÂ∫îÂ§±Ë¥•: ' + error.message));
                        }
                    },
                    onerror: function(error) {
                        reject(new Error('ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•'));
                    }
                });
            });
        }

        // Ëé∑ÂèñËØ≠Ë®ÄÂêçÁß∞
        getLanguageName(code) {
            const langMap = {
                'zh': '‰∏≠Êñá',
                'en': 'Ëã±Êñá',
                'ja': 'Êó•Êñá',
                'ko': 'Èü©Êñá',
                'fr': 'Ê≥ïÊñá',
                'de': 'Âæ∑Êñá',
                'es': 'Ë•øÁè≠ÁâôÊñá',
                'ru': '‰øÑÊñá'
            };
            return langMap[code] || '‰∏≠Êñá';
        }

        // Ê∏ÖÁ©∫ÊñáÊú¨
        clearText() {
            document.getElementById('ds-input-text').value = '';
            document.getElementById('ds-result-area').textContent = 'ÁøªËØëÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫';
        }

        // ÊòæÁ§∫Èù¢Êùø
        showPanel() {
            console.log('üì± ÊòæÁ§∫Èù¢ÊùøÊñπÊ≥ïË¢´Ë∞ÉÁî®');
            
            // Ê£ÄÊü•Èù¢ÊùøÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!this.overlay || !this.panel) {
                console.error('‚ùå Èù¢ÊùøÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞ÂàõÂª∫');
                this.createTranslatePanel();
            }
            
            // Ê£ÄÊü•Èù¢ÊùøÊòØÂê¶Âú®DOM‰∏≠
            if (!document.body.contains(this.panel)) {
                console.error('‚ùå Èù¢Êùø‰∏çÂú®DOM‰∏≠ÔºåÈáçÊñ∞Ê∑ªÂä†');
                document.body.appendChild(this.overlay);
                document.body.appendChild(this.panel);
            }
            
            console.log('‚úÖ ËÆæÁΩÆÈù¢ÊùøÊòæÁ§∫');
            this.overlay.style.display = 'block';
            this.panel.style.display = 'block';
            
            // Ê£ÄÊü•ËæìÂÖ•Ê°ÜÊòØÂê¶Â≠òÂú®
            const inputElement = document.getElementById('ds-input-text');
            if (inputElement) {
                inputElement.focus();
                console.log('‚úÖ ËæìÂÖ•Ê°ÜÂ∑≤ËÅöÁÑ¶');
            } else {
                console.error('‚ùå Êâæ‰∏çÂà∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
            }
        }

        // ÈöêËóèÈù¢Êùø
        hidePanel() {
            this.overlay.style.display = 'none';
            this.panel.style.display = 'none';
        }

        // Ê£ÄÊü•Èù¢ÊùøÊòØÂê¶ÂèØËßÅ
        isPanelVisible() {
            return this.panel.style.display === 'block';
        }

        // ‰ΩøÂÖÉÁ¥†ÂèØÊãñÊãΩ
        makeDraggable(element) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            element.onmousedown = (e) => {
                // Âè™Âú®Èº†Ê†áÂè≥ÈîÆÊàñ‰∏≠ÈîÆÊó∂ÂÖÅËÆ∏ÊãñÊãΩÔºåÂ∑¶ÈîÆÁî®‰∫éÁÇπÂáª
                if (e.button !== 0) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(element.style.left) || 0;
                startTop = parseInt(element.style.top) || 0;
                
                element.style.cursor = 'grabbing';
                console.log('üñ±Ô∏è ÂºÄÂßãÊãñÊãΩ');
                
                // ‰∏¥Êó∂Á¶ÅÁî®ÁÇπÂáª‰∫ã‰ª∂
                element.style.pointerEvents = 'none';
                setTimeout(() => {
                    element.style.pointerEvents = 'auto';
                }, 200);
                
                e.preventDefault();
            };
            
            document.onmousemove = (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;
                
                // ËæπÁïåÊ£ÄÊü•
                const maxLeft = window.innerWidth - element.offsetWidth;
                const maxTop = window.innerHeight - element.offsetHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));
                
                element.style.left = newLeft + 'px';
                element.style.top = newTop + 'px';
                
                // ‰øùÂ≠ò‰ΩçÁΩÆ
                CONFIG.BUTTON_POSITION.x = newLeft;
                CONFIG.BUTTON_POSITION.y = newTop;
                GM_setValue('buttonPosition', CONFIG.BUTTON_POSITION);
            };
            
            document.onmouseup = () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'pointer';
                    console.log('üñ±Ô∏è ÁªìÊùüÊãñÊãΩ');
                }
            };
        }
    }

    // ========================================
    // ÂàùÂßãÂåñ
    // ========================================
    function init() {
        console.log('üîß ÂºÄÂßãÂàùÂßãÂåñ DeepSeek ÁøªËØëÂä©Êâã...');
        
        // Âè™Âú®È°∂Â±ÇÁ™óÂè£ËøêË°åÔºåÈÅøÂÖçÂú® iframe ‰∏≠ÈáçÂ§çÂàõÂª∫
        if (window.self !== window.top) {
            console.log('‚è≠Ô∏è Ê£ÄÊµãÂà∞ iframe ÁéØÂ¢ÉÔºåË∑≥ËøáÂàùÂßãÂåñ');
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂàùÂßãÂåñËøá
        if (document.querySelector('.ds-float-ball')) {
            console.log('‚è≠Ô∏è ÊÇ¨ÊµÆÁêÉÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ');
            return;
        }
        
        // Á°Æ‰øù body ÂÖÉÁ¥†Â≠òÂú®
        if (!document.body) {
            console.log('‚è≥ Á≠âÂæÖ body ÂÖÉÁ¥†...');
            setTimeout(init, 100);
            return;
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰ΩçÁΩÆ
        const savedPosition = GM_getValue('buttonPosition', CONFIG.BUTTON_POSITION);
        CONFIG.BUTTON_POSITION = savedPosition;
        
        // ÂàõÂª∫ÁøªËØëÂô®ÂÆû‰æã
        try {
            new SimpleTranslator();
            console.log('‚úÖ DeepSeek ÁøªËØëÂä©ÊâãÂàùÂßãÂåñÊàêÂäü');
        } catch (error) {
            console.error('‚ùå ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
        
        // Â¶ÇÊûúÊú™ÈÖçÁΩÆ API KeyÔºåÊòæÁ§∫ÊèêÁ§∫
        if (!CONFIG.API_KEY) {
            console.warn('‚ö†Ô∏è ËØ∑ÈÖçÁΩÆ DeepSeek API Key Âêé‰ΩøÁî®ÁøªËØëÂäüËÉΩ');
        }
    }

    // Á°Æ‰øùÂè™ÂàùÂßãÂåñ‰∏ÄÊ¨°
    let initialized = false;
    
    function safeInit() {
        if (initialized) {
            console.log('‚è≠Ô∏è Â∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÊâßË°å');
            return;
        }
        initialized = true;
        init();
    }

    // Â§öÁßçÊñπÂºèÁ°Æ‰øùÂàùÂßãÂåñÔºå‰ΩÜÈÅøÂÖçÈáçÂ§ç
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', safeInit, { once: true });
    } else {
        safeInit();
    }

})();